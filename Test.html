<!DOCTYPE html>
<html>
<!-- UsefulJS test page -->
<head>
    <title>Test</title>
    <meta charset="UTF-8">
    <meta name="author" content="Christopher Williams">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/ujs.css">
    <style type="text/css">
        .failed {
            color : red;
        }
        .passed {
            color : green;
        }
        .informational {
            color : blue;
        }
        .outer {
            width : 10em;
            height : 6em;
            padding-top: 2em;
            border : 1px solid black;
            margin : 1em;
            text-align : center;
        }
        .inner {
            width : 8em;
            padding: 0.4em;
            display: inline-block;
        }
        .cal {
            border-left: 1px solid black;
            border-bottom: 1px solid black;
        }
        .cal TH {
            border-right: 1px solid black;
            background-color: black;
            color: white;
            width: 2.9em;
            height : 1.4em;
            font-weight: normal;
            padding: 0.2em 0;
            text-align: center;
        }
        .cal TH.chead {
            border-bottom: 1px solid white;
            width: 100%
        }
        .cal TD {
            width: 2.9em;
            height: 2.9em;
            text-align: center;
            border-top: 1px solid black;
            border-right: 1px solid black;
        }
        .cal TD SPAN {
            display: inline-block;
            text-align: right;
            width: 1.5em;
        }
        .hdr {
            display : inline-block;
            border-bottom-style: solid;
            border-bottom-width: 1px;
            padding-bottom: 2px;
            margin-bottom: 0.5em;
        }
        .msie-7 .hdr {
            border-bottom-width: 0!important;
            font-weight: bold;
            margin-top: 1em;
        }
        #dragContainer {
            height: 280px;
            width: 280px;
            padding: 14px;
            border : 1px solid black;
            position: relative;
            margin-bottom: 5px;
        }
        #dragSink {
            width : 84px;
            height : 84px;
            border : 1px solid black;
        }
        .droppable {
            background-color: #EEE;
        }
        .ball {
            background-color : black;
            color: white;
            font-weight: bold;
            height: 24px;
            width: 24px;
            line-height: 24px;
            font-size: 16px;
            border-radius: 13px;
            position: absolute;
            text-align: center;
            cursor: default;
        }
        #stylable {
            padding: 5px;
            border: 1px solid black;
            width: 120px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 5px;
        }
    </style>
    <link rel="stylesheet" href="data:text/css,%23stylable%20{%20background-color:%20white;%20color:%20black;%20}" title="W+B">
    <link rel="alternate stylesheet" href="data:text/css,%23stylable%20{%20background-color:%20black;%20color:%20white;%20}" title="B+W">
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a href="index.html" class="navbar-brand">UsefulJS</a>
    </div>

    <div class="collapse navbar-collapse navbar-ex1-collapse">
        <ul class="nav navbar-nav">
            <li class="dropdown">
                <a href="docs/index.html">Documentation</a>
            </li>
            <li class="dropdown active">
                <a href="#">Tests</a>
            </li>
            <li class="dropdown">
                <a href="examples/index.html">Examples</a>
            </li>
        </ul>
    </div>
</nav>
<div class="container">
    <pre id="testOutput"></pre>
</div>
<!--script src="src/core.js" type="text/javascript"></script>
<script src="src/query.js" type="text/javascript"></script>
<script src="src/storage.js" type="text/javascript"></script>
<script src="src/array.js" type="text/javascript"></script>
<script src="src/numeric.js" type="text/javascript"></script>
<script src="src/classlist.js" type="text/javascript"></script>
<script src="src/string.js" type="text/javascript"></script>
<script src="src/date.js" type="text/javascript"></script>
<script src="src/event.js" type="text/javascript"></script>
<script src="src/locale_en.js" type="text/javascript"></script>
<script src="src/locale_western_europe.js" type="text/javascript"></script>
<script src="src/locale_northern_europe.js" type="text/javascript"></script>
<script src="src/locale_eastern_europe.js" type="text/javascript"></script>
<script src="src/locale_middle_east.js" type="text/javascript"></script>
<script src="src/locale_asia.js" type="text/javascript"></script>
<script src="src/locale_africa.js" type="text/javascript"></script>
<script src="extensions/browser.js" type="text/javascript"></script>
<script src="extensions/dnd.js" type="text/javascript"></script>
<script src="extensions/skin.js" type="text/javascript"></script>
<script src="extensions/currency.js" type="text/javascript"></script-->
<script src="built/UsefulJS-min-full-latest.js"></script>
<script type="text/javascript">
// BEGIN_JAVASCRIPT
window.onload = function() {
"use strict";
var _u = UsefulJS, msg = "", 
    p = document.getElementById("testOutput"),
    eol = "<br>"; // For Internet Explorer
var testVal, passed, passMark, 
    pM_y = '<span class="passed">(Y)</span> ',
    pM_n = '<span class="failed">(N)</span> ',
    pM_i = '<span class="informational">(I)</span> ',
    testBase, expected, thrown, testInput, fmtStr, p1, p2, p3, before, after,
    formatHdr = function(text) {
        msg += '<div class="hdr">' + text + '</div>' + eol;
    };

try {
var fixed = _u.fix({
    _browser : "all",
    _string : "all",
    _date : "all",
    _number : "all",
    _array : "all"
});
var _b = _u.Browser;

formatHdr('Browser tests');

msg += pM_i + "You appear to be using " + _b.name;
if (_b.mobile) {
    msg += " (Mobile)";
}
if (null !== _b.major) {
    msg += " " + _b.major;
}
if (null !== _b.minor) {
    msg += "." + _b.minor;
}
if (_b.engine) {
    msg += " (" + _b.engine;
    if (null !== _b.engineMajor) {
        msg += " " + _b.engineMajor;
    }
    if (null !== _b.engineMinor) {
        msg += "." + _b.engineMinor;
    }
    msg += ")";
}
msg += eol;

if (fixed._browser.identify) {
    msg += pM_i + "Added these classes to the &lt;html&gt; element: " + document.documentElement.className + eol;
}
msg += pM_i + "Determined this locale from browser settings: " + _u.Locale.current + eol;
msg += pM_i + 'Detected the following list separator on this system: "' +
    _u.listSeparator + '"' + eol;
if (fixed._core.language) {
    msg += pM_i + "FIXED: navigator.language property added: " + navigator.language + eol;
}
else if ("language" in navigator) {
    msg += pM_i + "NOT FIXED: navigator.language is natively supported" + eol;
}
if ("\\s" === _u.RE_WS.source) {
    msg += pM_i + "NOT FIXED: /\\s/ is already Unicode aware on this system" + eol;
}
else {
    msg += pM_i + "FIXED: /\\s/ is not fully Unicode-aware on this system; " + 
        "you can use UsefulJS.RE_WS to test for whitespace:" + eol + "\t" + _u.RE_WS + eol;
}
msg += pM_i + 'Browser supports strict mode: ' + (_u.featureSupport.strictMode ? "yes" : "no") + eol;

msg += eol;

var doTest = function(testDesc, testVal, testCond) {
    passMark = testCond ? pM_y : pM_n;
    msg += passMark + testDesc + eol;
    if (!testCond) {
        msg += "\tCheck: ";
        if (_typeof(testVal) === "string") {
            msg += "'" + testVal + "'";
        }
        else {
            msg += String(testVal);
        }
        msg += eol;
    }
};

formatHdr('UsefulJS core');
if (fixed._core.defined) {
    msg += pM_i + "FIXED: added defined function to the global context" + eol;
}
else if ("defined" in _u.globalObject) {
    msg += pM_i + "NOT FIXED: defined function is natively supported" + eol;
}
if (fixed._core._typeof) {
    msg += pM_i + "FIXED: added _typeof function to the global context" + eol;
}
else if ("_typeof" in _u.globalObject) {
    msg += pM_i + "NOT FIXED: _typeof function is natively supported" + eol;
}
if (fixed._core.clone) {
    msg += pM_i + "FIXED: added clone function to the global context" + eol;
}
else if ("clone" in _u.globalObject) {
    msg += pM_i + "NOT FIXED: clone function is natively supported" + eol;
}
if (fixed._core.bindFunction) {
    msg += pM_i + "FIXED: added bind method to Function.prototype" + eol;
}
else if ("bind" in Function.prototype) {
    msg += pM_i + "NOT FIXED: Function.prototype.bind is natively supported" + eol;
}
if (fixed._core.is) {
    msg += pM_i + "FIXED: added is static method to Object" + eol;
}
else if ("is" in Object) {
    msg += pM_i + "NOT FIXED: Object.is is natively supported" + eol;
}
msg += eol;

formatHdr('defined tests');
testVal = defined(undefined);
doTest( 'defined(undefined) === false', testVal, (testVal === false));
testVal = defined(null);
doTest( 'defined(null) === false', testVal, (testVal === false));
testVal = defined(false);
doTest( 'defined(false) === true', testVal, (testVal === true));
testVal = defined(0);
doTest( 'defined(0) === true', testVal, (testVal === true));
testVal = defined("");
doTest( 'defined("") === true', testVal, (testVal === true));

msg += eol;

formatHdr('_typeof tests');
// Null / undefined
testVal = _typeof(undefined);
doTest( '_typeof(undefined) === "undefined"', testVal, (testVal === "undefined"));
testVal = _typeof(null);
doTest( '_typeof(null) === "null"', testVal, (testVal === "null"));

// Strings
testVal = _typeof("s");
doTest( '_typeof("s") === "string"', testVal, (testVal === "string"));
testVal = _typeof(new String("s"));
doTest( '_typeof(new String("s")) === "string"', testVal, (testVal === "string"));
testVal = _typeof([].toString());
doTest( '_typeof([].toString()) === "string"', testVal, (testVal === "string"));
testVal = _typeof(String(1));
doTest( '_typeof(String(1)) === "string"', testVal, (testVal === "string"));

// Numbers
expected = "number";
testVal = _typeof(1);
doTest('_typeof(1) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(Number("1"));
doTest('_typeof(Number("1")) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(new Number(1));
doTest('_typeof(new Number(1)) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(parseInt("1", 10));
doTest('_typeof(parseInt("1", 10)) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(parseFloat("1.23"));
doTest('_typeof(parseFloat("1.23")) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(Math.PI);
doTest('_typeof(Math.PI) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(Number.NaN);
doTest('_typeof(Number.NaN) === "' + expected + '"', testVal, testVal === expected);

// Booleans
expected = "boolean";
testVal = _typeof(false);
doTest('_typeof(false) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(!!1);
doTest('_typeof(!!1) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(Boolean("true"));
doTest('_typeof(Boolean("true")) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(new Boolean(true));
doTest('_typeof(new Boolean(true)) === "' + expected + '"', testVal, testVal === expected);

// Functions
expected = "function";

testVal = _typeof(function() {});
doTest('_typeof(function() {}) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(new Function(""));
doTest('_typeof(new Function("")) === "' + expected + '"', testVal, testVal === expected);

// Arrays
expected = "array";

testVal = _typeof([]);
doTest('_typeof([]) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(new Array());
doTest('_typeof(new Array()) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof("a".match(/a/));
doTest('_typeof("a".match(/a/)) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(/a/.exec("a"));
doTest('_typeof(/a/.exec("a")) === "' + expected + '"', testVal, testVal === expected);

// Objects
expected = "object";

testVal = _typeof({});
doTest('_typeof({}) === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(new Object());
doTest('_typeof(new Object()) === "' + expected + '"', testVal, testVal === expected);

// Other builtin classes
testVal = _typeof(new Date());
doTest('_typeof(new Date()) === "date"', testVal, testVal === "date");

testVal = _typeof(new RegExp("a"));
doTest('_typeof(new RegExp("a")) === "regexp"', testVal, testVal === "regexp");

testVal = _typeof(/a/);
doTest('_typeof(/a/) === "regexp"', testVal, testVal === "regexp");

testVal = _typeof(new Error("a"));
doTest('_typeof(new Error("a")) === "error"', testVal, testVal === "error");

testVal = _typeof(new TypeError("a"));
doTest('_typeof(new TypeError("a")) === "error"', testVal, testVal === "error");

// Window
testVal = _typeof(window);
doTest('_typeof(window) === "window"', testVal, testVal === "window");

// DOM objects
expected = "document";
testVal = _typeof(document);
doTest('_typeof(document) === "' + expected + '"', testVal, testVal === expected);

expected = "element";
testVal = _typeof(document.getElementById("testOutput"));
doTest('_typeof(document.getElementById("testOutput")) === "' + expected + '"', 
    testVal, testVal === expected);

expected = "attr";
testVal = _typeof(document.getElementById("testOutput").attributes[0]);
doTest('_typeof(document.getElementById("testOutput").attributes[0]) === "' + expected + '"', 
    testVal, testVal === expected);

expected = "text";
testVal = _typeof(document.createTextNode("a"));
doTest('_typeof(document.createTextNode("a")) === "' + expected + '"', 
    testVal, testVal === expected);

if ("CustomEvent" in window) {
    try {
        expected = "event";
        testVal = _typeof(document.createEvent("CustomEvent"));
        doTest('_typeof(document.createEvent("CustomEvent")) === "' + expected + '"', 
            testVal, testVal === expected);
    }
    catch(e) {
        // Ignore
    }
}

msg += eol;

formatHdr('clone tests');

// Scalars
testVal = _u.clone(undefined);
doTest('Undefined not cloned', testVal, testVal === undefined);

testVal = _u.clone(null);
doTest('Null not cloned', testVal, testVal === null);

testVal = _u.clone(true);
doTest('Boolean not cloned', testVal, testVal === true);

testVal = _u.clone(1);
doTest('Number not cloned', testVal, testVal === 1);

testVal = _u.clone("a");
doTest('String not cloned', testVal, testVal === "a");

var f = function() {};
testVal = _u.clone(f);
doTest('Function not cloned', testVal, testVal === f);

// Date / regexp
var d = new Date(), d2 = _u.clone(d);
doTest('Date equal but not identical after cloning', d2,
    (d.getTime() === d2.getTime() && d !== d2));

var r = new RegExp("a", "gim"), r2 = _u.clone(r);
doTest('Regex equal but not identical after cloning', r2,
    (r.source === r2.source && r.global === r2.global &&
     r.ignoreCase === r2.ignoreCase && r.multiline === r2.multiline && r !== r2));

// Array
var a = [ "a", new Date() ], a2 = _u.clone(a);
doTest('Array and array items equal but not identical after cloning',
    a2, (a.length === a2.length && a[0] === a2[0] &&
    a[1].getTime() === a2[1].getTime() && a[1] !== a2[1] && a !== a2));

// Objects
var o = { a : "a", d : new Date() }, o2 = _u.clone(o);
doTest('Properties of Object are equal but not identical after cloning',
    o2, (o.a === o2.a && o.d.getTime() === o2.d.getTime() && o.d !== o2.d && o !== o2));

var S = function(a, d) {
    this.a = a;
    this.d = d;
    this.active = function() { return true; };
};
o = new S("a", new Date());
o2 = _u.clone(o);
doTest('Properties of user-defined class are equal but not identical after cloning',
    o2, (o.a === o2.a && o.d.getTime() === o2.d.getTime() && o.d !== o2.d && o !== o2));

if (_u.featureSupport.createObject && o2.active) {
    thrown = false;
    testVal = false;
    try {
        testVal = o2.active();
    }
    catch(e) {
        thrown = true;
    }
    doTest('A cloned user-defined class retains its identity',
        o2, (testVal === true && thrown === false));
}
else {
    msg += pM_i + 'This system does not support fully cloning user-defined classes' + eol;
}
testBase = "UsefulJS.clone";
if ("ArrayBuffer" in window) {
    if (ArrayBuffer.slice) {
        var ab1 = new ArrayBuffer(32);
        var ab2 = _u.clone(ab1);
        doTest(testBase + '(new ArrayBuffer(32)) successful',
            ab2, (ab1.byteLength === ab2.byteLength && ab1 !== ab2));
    }
}

// Circular reference
var circ1 = { a : 1, b : [] },
    circ2 = { a : 1, b : circ1 };
circ1.b.push(circ2);
thrown = false;
try {
    _u.clone(circ2);
}
catch(e) {
    thrown = true;
}
doTest(testBase + ': circular reference caught',
    thrown, thrown === true);

msg += eol;

if (fixed._core.is) {
    formatHdr('Object.is tests');
    
    testBase = "Object.is";
    
    testInput = "a";
    p1 = "A";
    testVal = Object.is(testInput, p1);
    expected = false;
    doTest(testBase + '("' + testInput + '", "' + p1 + '") === ' + expected,
        testVal, !testVal);
        
    p1 = testInput;
    testVal = Object.is(testInput, p1);
    expected = true;
    doTest(testBase + '("' + testInput + '", "' + p1 + '") === ' + expected,
        testVal, testVal);
        
    testInput = 0;
    p1 = -0;
    testVal = Object.is(testInput, p1);
    expected = false;
    doTest(testBase + '(' + testInput + ', -' + p1 + ') === ' + expected,
        testVal, !testVal);
    
    testInput = -0;    
    p1 = -0;
    testVal = Object.is(testInput, p1);
    expected = true;
    doTest(testBase + '(-' + testInput + ', -' + p1 + ') === ' + expected,
        testVal, testVal);
    
    testInput = Number.NaN;    
    p1 = Number.NaN;
    testVal = Object.is(testInput, p1);
    expected = true;
    doTest(testBase + '(Number.' + testInput + ', Number.' + p1 + ') === ' + expected,
        testVal, testVal);
    
    msg += eol;
}

formatHdr('Locale resolution tests');

testBase = "UsefulJS.Locale.alias";
var _l = UsefulJS.Locale;
testVal = _l.alias("zh-Hans-CN");
expected = "zh";
doTest(testBase + '("zh-Hans-CN") === "zh"',
    testVal, testVal === expected);

testVal = _l.alias("zh-Mong");
expected = "zh";
doTest(testBase + '("zh-Mong") === "zh"',
    testVal, testVal === expected);

testVal = _l.alias("quz-PE");
expected = UsefulJS.Locale.current;
doTest(testBase + '("quz-PE") === "' + expected + '"',
    testVal, testVal === expected);

testBase = "UsefulJS.Locale.lookup";
testInput = ["ja-JP-u-nu-fullwidth", "zh-Hant-u-nu-hanidec"];
testVal = _l.lookup(testInput);
expected = ["ja", "nu-fullwidth"];
doTest(testBase + '(["' + testInput.join('", "') + '"]) === ["' + expected.join('", "') + '"]',
    testVal, testVal.toString() === expected.toString());

testInput = ["quz-PE", "es-PE"];
testVal = _l.lookup(testInput);
expected = ["es-PE", ""];
doTest(testBase + '(["' + testInput.join('", "') + '"]) === ["' + expected.join('", "') + '"]',
    testVal, testVal.toString() === expected.toString());

msg += eol;

formatHdr('pad tests');
testBase = 'UsefulJS.pad';
testVal = _u.pad("1234", 6);
expected = "  1234";
doTest(testBase + '("1234", 6) === "' + expected + '"',
    testVal, testVal === expected);

testVal = _u.pad("1234", 6, "0");
expected = "001234";
doTest(testBase + '("1234", 6, "0") === "' + expected + '"',
    testVal, testVal === expected);

testVal = _u.pad("1234", 3);
expected = "1234";
doTest(testBase + '("1234", 3) === "' + expected + '"',
    testVal, testVal === expected);

testVal = _u.pad("1234", 6, null, true);
expected = "1234  ";
doTest(testBase + '("1234", 6, null, true) === "' + expected + '"',
    testVal, testVal === expected);

msg += eol;

formatHdr('Object iteration tests');

testInput = { a : 1, b : 2, c : 3, toString : function() { return "{a:" + this.a + ",b:" + this.b + ",c:" + this.c + "}"; } };

if (!"keys" in Object) {
    testVal = _u.keys(testInput);
    testVal.sort();
    expected = ["a", "b", "c", "toString"];
    doTest('UsefulJS.keys(' + testInput.toString() + ') === ["a", "b", "c", "toString"]',
        testVal, testVal.toString() === expected.toString());

    testVal = _u.keys([1, 2, 3 ,4]);
    expected = ["0", "1", "2", "3"];
    doTest('UsefulJS.keys([1, 2, 3 ,4]) === ["0", "1", "2", "3"]',
        testVal, testVal.toString() === expected.toString());
}

testBase = 'UsefulJS'
testVal = _u.every({}, function() {}, null);
expected = true;
doTest(testBase + '.every({}, function() {}, null) === true',
    testVal, testVal === expected);

testVal = _u.some({}, function() {}, null);
expected = false;
doTest(testBase + '.some({}, function() {}, null) === false',
    testVal, testVal === expected);
    
var finder = {
    even : true,
    find : function(v, k, o) {
        var ret = (v % 2);
        if (this.even) {
            ret = !ret;
        }
        return ret;
    },
    toString : function() {
        return '{even:' + this.even + '}';
    }
}
testVal = _u.find(testInput, finder.find, finder);
expected = 2;
doTest(testBase + '.find(' + testInput.toString() + ', ' + finder.find + ', ' +
    finder.toString() + ') === ' + expected, testVal, testVal === expected);
    
finder.even = false;
testVal = _u.findKey(testInput, finder.find, finder);
expected = "a";
doTest(testBase + '.findKey(' + testInput.toString() + ', ' + finder.find + ', ' +
    finder.toString() + ') === "' + expected + '"', testVal, testVal === expected);

testVal = _typeof(_u.map({}, function() {}, null));
expected = "object";
doTest('_typeof(' + testBase + '.map({}, function() {}, null)) === "' + expected + '"',
    testVal, testVal === expected);

testVal = _typeof(_u.map([], function() {}, null));
expected = "array";
doTest('_typeof(' + testBase + '.map([], function() {}, null)) === "' + expected + '"',
    testVal, testVal === expected);

testVal = _typeof(_u.filter({}, function() {}, null));
expected = "object";
doTest('_typeof(' + testBase + '.filter({}, function() {}, null)) === "' + expected + '"',
    testVal, testVal === expected);

testVal = _typeof(_u.forEach({}, function() {}, null));
expected = "undefined";
doTest('_typeof(' + testBase + '.forEach({}, function() {}, null)) === "' + expected + '"',
    testVal, testVal === expected);

// Foreach, no context
testBase = 'UsefulJS.forEach';
var count = -1;
fmtStr = testInput.toString();
expected = _u.keys(testInput).length;
var ffE = function(item, key, obj) { count = (count === -1) ? 1 : count + 1; };
_u.forEach(testInput, ffE, null);
doTest(testBase + '(' + fmtStr + ', ' + eol + '    \t' + ffE + 
    ', null) visits ' + expected + ' items',
    count, count === expected);

// Perturb the object
count = -1;
expected -= 1;
var ffE = function(item, key, obj) { count = (count === -1) ? 1 : count + 1; delete(obj.c); };
_u.forEach(testInput, ffE, null);
doTest(testBase + '(' + fmtStr + ', ' + eol + '    \t' + ffE + 
    ', null) visits ' + expected + ' items',
    count, count === expected);

testInput = { a : 1, b : 2, c : 3 };

// Visitor class for testing iteration with callback to a class instance
var OVisitor = function() {
    this.visited = -1;
    this.visit = function(i, k, o) {
        this.visited = (-1 === this.visited) ? 1 : this.visited + 1;
    };
    this.every_all = function(i, k, o) {
        this.visit(i, k, o);
        return true;
    };
    this.every_some = function(i, k, o) {
        this.visit(i, k, o);
        return (this.visited < 2);
    };
    this.some_all = function(i, k, o) {
        this.visit(i, k, o);
        return false;
    };
    this.some_some = function(i, k, o) {
        this.visit(i, k, o);
        return (this.visited === 2);
    };
    this.filter_some = function(i, k, o) {
        this.visit(i, k, o);
        return (k !== 'b');
    };
    this.map = function(i, k, o) {
        this.visit(i, k, o);
        return i * i;
    };
};

var ovisitor = new OVisitor();

_u.forEach(testInput, ovisitor.visit, ovisitor);
testVal = ovisitor.visited;
expected = _u.keys(testInput).length;
doTest(testBase + '(' + fmtStr + ', ' + ovisitor.visit + ', ovisitor) visits ' + expected + ' items',
    testVal, testVal === expected);

ovisitor.visited = -1;
testBase = 'UsefulJS.every';
expected = [3, true];
testVal = _u.every(testInput, ovisitor.every_all, ovisitor);
testVal = [ovisitor.visited, testVal];
doTest(testBase + '(' + fmtStr + ', ' + ovisitor.every_all + ', visitor) visits ' + 
    expected[0] + ' items and returns ' + expected[1],
    testVal, testVal.toString() === expected.toString());

ovisitor.visited = -1;
expected = [2, false];
testVal = _u.every(testInput, ovisitor.every_some, ovisitor);
testVal = [ovisitor.visited, testVal];
doTest(testBase + '(' + fmtStr + ', ' + ovisitor.every_some + ', visitor) visits ' + 
    expected[0] + ' items and returns ' + expected[1],
    testVal, testVal.toString() === expected.toString());

ovisitor.visited = -1;
testBase = 'UsefulJS.some';
expected = [3, false];
testVal = _u.some(testInput, ovisitor.some_all, ovisitor);
testVal = [ovisitor.visited, testVal];
doTest(testBase + '(' + fmtStr + ', ' + ovisitor.some_all + ', visitor) visits ' + 
    expected[0] + ' items and returns ' + expected[1],
    testVal, testVal.toString() === expected.toString());

ovisitor.visited = -1;
expected = [2, true];
testVal = _u.some(testInput, ovisitor.some_some, ovisitor);
testVal = [ovisitor.visited, testVal];
doTest(testBase + '(' + fmtStr + ', ' + ovisitor.some_some + ', visitor) visits ' + 
    expected[0] + ' items and returns ' + expected[1],
    testVal, testVal.toString() === expected.toString());

ovisitor.visited = -1;
testBase = 'UsefulJS.filter';
expected = [3, _u.clone(testInput)];
testVal = _u.filter(testInput, ovisitor.every_all, ovisitor);
testVal = [ovisitor.visited, testVal];
doTest(testBase + '(' + fmtStr + ', ' + ovisitor.every_all + ', visitor) visits ' + 
    expected[0] + ' items and returns ' + fmtStr,
    testVal, testVal[0] === expected[0] && testVal[1].a === expected[1].a && 
    testVal[1].b === expected[1].b && testVal[1].c === expected[1].c);

ovisitor.visited = -1;
expected = [3, { a : 1, c : 3 }];
testVal = _u.filter(testInput, ovisitor.filter_some, ovisitor);
testVal = [ovisitor.visited, testVal];
doTest(testBase + '(' + fmtStr + ', ' + ovisitor.filter_some + ', visitor) visits ' + 
    expected[0] + ' items and returns { a : 1, c : 3 }',
    testVal, testVal[0] === expected[0] && testVal[1].a === expected[1].a && 
    !("b" in testVal[1]) && testVal[1].c === expected[1].c);

ovisitor.visited = -1;
testBase = 'UsefulJS.map';
expected = [3, { a : 1, b : 4, c : 9 }];
testVal = _u.map(testInput, ovisitor.map, ovisitor);
testVal = [ovisitor.visited, testVal];
doTest(testBase + '(' + fmtStr + ', ' + ovisitor.map + ', visitor) visits ' + 
    expected[0] + ' items and returns { a : 1, b : 4, c : 9 }',
    testVal, testVal[0] === expected[0] && testVal[1].a === expected[1].a && 
    testVal[1].b === expected[1].b && testVal[1].c === expected[1].c);

msg += eol;

formatHdr('UsefulJS.uuid test');

testVal = _u.uuid();
doTest('"' + testVal + '" has the expected form', testVal, 
    /[0-9a-f]{8}\-4[0-9a-f]{3}\-[0-9a-f]{4}\-[89ab][0-9a-f]{3}\-[0-9a-f]{12}/.test(testVal));

msg += eol;

if (fixed._core.bindFunction) {
    formatHdr('Function.prototype.bind tests');
    var thing = {
        fn : function(a, b, c) {
            return [a, b, c, this.prop];
        }
    },
    thang = {
        prop : 3
    };
    thing.fn = thing.fn.bind(thang, 0, 1);
    testVal = thing.fn(2);
    expected = [0, 1, 2, 3];
    doTest('Function bound to context with default arguments',
        testVal, testVal.toString() === expected.toString());
    msg += eol;
}

msg += eol;

formatHdr('UsefulJS.Query');

msg += eol;

formatHdr('parse tests');

var _Q = UsefulJS.Query;
testInput = "?pickup&size=14&topping=pepperoni&topping=extra+cheese&coupon=0144732";
testBase = 'UsefulJS.Query.parse("' + testInput + '")';

var qParsed = _Q.parse(testInput);
testVal = qParsed.pickup;
expected = true;
doTest(testBase + '.pickup === true', testVal, testVal === expected);

testVal = qParsed.size;
expected = 14;
doTest(testBase + '.size === 14', testVal, testVal === expected);

testVal = qParsed.coupon;
expected = "0144732";
doTest(testBase + '.coupon === "0144732"', testVal, testVal === expected);

testVal = qParsed.topping;
expected = ["pepperoni", "extra cheese"];
doTest(testBase + '.topping == ["pepperoni", "extra cheese"]', testVal,
    testVal[0] === expected[0] && testVal[1] === expected[1]);

msg += eol;

formatHdr('build tests');

testBase = "UsefulJS.Query.append";

testVal = _Q.append("", "pickup", true);
expected = "pickup";
doTest(testBase + '("", "pickup", true) === "' + expected + '"',
    testVal, testVal === expected);

testVal = _Q.append(testVal, "delivery", false);
expected = "pickup";
doTest(testBase + '("", "delivery", false) === "' + expected + '"',
    testVal, testVal === expected);

testVal = _Q.append(testVal, "size", 14);
expected = "pickup&size=14";
doTest(testBase + '("pickup", "size", 14) === "' + expected + '"',
    testVal, testVal === expected);

testVal = _Q.append(testVal, "coupon", "01234");
expected = "pickup&size=14&coupon=01234";
doTest(testBase + '("pickup&size=14", "coupon", "01234") === "' + expected + '"',
    testVal, testVal === expected);

testVal = _Q.append(testVal, "topping", ["pepperoni", "extra cheese"]);
expected = "pickup&size=14&coupon=01234&topping=pepperoni&topping=extra%20cheese";
doTest(testBase + '("pickup&size=14&coupon=01234", "topping", ["pepperoni", "extra cheese"]) === ' + 
    eol + '\t"' + expected + '"', testVal, testVal === expected);

msg += eol + eol;

formatHdr('UsefulJS.Storage');

var _S = UsefulJS.Storage;

if (fixed._storage.localStorage) {
    msg += pM_i + 'FIXED: Added localStorage to global context' + eol;
}
else if (_u.featureSupport.storage.local) {
    msg += pM_i + 'NOT FIXED: localStorage is natively supported' + eol;
}
else {
    msg += pM_i + 'NOT FIXED: localStorage appears to have been disabled' + eol;
}
if (fixed._storage.sessionStorage) {
    msg += pM_i + 'FIXED: Added sessionStorage to global context' + eol;
}
else if (_u.featureSupport.storage.session) {
    msg += pM_i + 'NOT FIXED: sessionStorage is natively supported' + eol;
}
else {
    msg += pM_i + 'NOT FIXED: sessionStorage appears to have been disabled' + eol;
}
msg += eol;

testBase = "UsefulJS.Storage";
formatHdr('Cookie tests');

if (_u.featureSupport.storage.cookies) {
    msg += pM_i + 'Cookies are enabled' + eol;

    var cookieName = "UsefulJSTest", testCookie;

    thrown = false;
    try {
        testCookie = new _S();
    }
    catch(e) {
        thrown = true;
    }
    doTest('new ' + testBase + '() throws',
        thrown, thrown === true);

    thrown = false;
    try {
        testCookie = new _S({});
    }
    catch(e) {
        thrown = true;
    }
    doTest('new ' + testBase + '({}) throws',
        thrown, thrown === true);

    testCookie = new _S(cookieName);
    testCookie.setItem("testKey", "testValue");

    doTest("Test cookie: set",
        document.cookie, document.cookie.indexOf(cookieName) >= 0);

    testCookie = new _S(cookieName);
    testVal = testCookie.getItem("testKey");
    expected = "testValue";
    doTest("Test cookie: reloaded",
        testVal, testVal === expected);

    testVal = testCookie.length;
    expected = 1;
    doTest('Test cookie: length === ' + expected,
        testVal, testVal === expected);

    if (!testCookie.hasOwnProperty("length")) {
        // Set via Object.defineProperty
        try {
            testCookie.length = 2;
        }
        catch(e) {
        }
        testVal = testCookie.length;
        expected = 1;
        doTest('Test cookie: length is read-only',
            testVal, testVal === expected);
    }

    testVal = testCookie.key(0);
    expected = "testKey";
    doTest('Test cookie: first key === "' + expected + '"',
        testVal, testVal === expected);

    testVal = testCookie.key(1);
    expected = null;
    doTest('Test cookie: no other keys found',
        testVal, testVal === expected);

    testCookie.setItem("testKey2", "testValue2");
    testVal = testCookie.getItem("testKey2");
    expected = "testValue2";
    doTest('Test cookie: second value set',
        [testVal, testCookie.length], (testVal === expected && testCookie.length === 2));

    testCookie.setItem("testKey3");
    testVal = testCookie.getItem("testKey3");
    expected = "undefined";
    doTest('Test cookie: values stored as Strings',
        testVal, testVal === expected);

    testVal = testCookie.getItem("testKey4");
    expected = null;
    doTest('Test cookie: non-existent keys return null',
        testVal, testVal === expected);

    testCookie.removeItem("testKey3");
    testVal = testCookie.getItem("testKey3");
    expected = null;
    doTest('Test cookie: removed item',
        [testVal, testCookie.length], (testVal === expected && testCookie.length === 2));

    testCookie.clear();
    doTest("Test cookie: cleared",
        document.cookie, document.cookie.indexOf(cookieName) < 0);

    msg += eol;

    if (fixed._storage.localStorage) {
        formatHdr('localStorage');
        localStorage.setItem("testKey", "testValue");
        testVal = localStorage.getItem("testKey");
        expected = "testValue";
        doTest('localStorage: set value', testVal, testVal === expected);
        localStorage.clear();
        msg += eol;
    }
    if (fixed._storage.sessionStorage) {
        formatHdr('sessionStorage');
        sessionStorage.setItem("testKey", "testValue");
        testVal = sessionStorage.getItem("testKey");
        expected = "testValue";
        doTest('sessionStorage: set value', testVal, testVal === expected);
        sessionStorage.clear();
        msg += eol;
    }
}
else {
    msg += pM_i + 'Cookies are disabled' + eol;
}


msg += eol;

formatHdr('UsefulJS.Array');

var _A = UsefulJS.Array;
testBase = "UsefulJS.Array";
if (fixed._array.isArray) {
    msg += pM_i + 'FIXED: isArray static method added to Array' + eol;
}
else if ("isArray" in Array) {
    msg += pM_i + 'NOT FIXED: Array.isArray is natively supported' + eol;
}
if (fixed._array.indexOf) {
    msg += pM_i + 'FIXED: Added indexOf method to Array.prototype' + eol;
}
else if ("indexOf" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.indexOf is natively supported' + eol;
}
if (fixed._array.lastIndexOf) {
    msg += pM_i + 'FIXED: Added lastIndexOf method to Array.prototype' + eol;
}
else if ("lastIndexOf" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.lastIndexOf is natively supported' + eol;
}
if (fixed._array.forEach) {
    msg += pM_i + 'FIXED: Added forEach method to Array.prototype' + eol;
}
else if ("forEach" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.forEach is natively supported' + eol;
}
if (fixed._array.every) {
    msg += pM_i + 'FIXED: Added every method to Array.prototype' + eol;
}
else if ("every" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.every is natively supported' + eol;
}
if (fixed._array.some) {
    msg += pM_i + 'FIXED: Added some method to Array.prototype' + eol;
}
else if ("some" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.some is natively supported' + eol;
}
if (fixed._array.filter) {
    msg += pM_i + 'FIXED: Added filter method to Array.prototype' + eol;
}
else if ("filter" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.filter is natively supported' + eol;
}
if (fixed._array.map) {
    msg += pM_i + 'FIXED: Added map method to Array.prototype' + eol;
}
else if ("map" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.map is natively supported' + eol;
}
if (fixed._array.reduce) {
    msg += pM_i + 'FIXED: Added reduce method to Array.prototype' + eol;
}
else if ("reduce" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.reduce is natively supported' + eol;
}
if (fixed._array.reduceRight) {
    msg += pM_i + 'FIXED: Added reduceRight method to Array.prototype' + eol;
}
else if ("reduceRight" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.reduceRight is natively supported' + eol;
}
if (fixed._array.find) {
    msg += pM_i + 'FIXED: Added find method to Array.prototype' + eol;
}
else if ("find" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.find is natively supported' + eol;
}
if (fixed._array.findIndex) {
    msg += pM_i + 'FIXED: Added findIndex method to Array.prototype' + eol;
}
else if ("findIndex" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.findIndex is natively supported' + eol;
}
if (fixed._array.fill) {
    msg += pM_i + 'FIXED: Added fill method to Array.prototype' + eol;
}
else if ("fill" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.fill is natively supported' + eol;
}
if (fixed._array.copyWithin) {
    msg += pM_i + 'FIXED: Added copyWithin method to Array.prototype' + eol;
}
else if ("copyWithin" in Array.prototype) {
    msg += pM_i + 'NOT FIXED: Array.prototype.copyWithin is natively supported' + eol;
}
if (fixed._array.from) {
    msg += pM_i + 'FIXED: Added from factory method to Array' + eol;
}
else if ("from" in Array) {
    msg += pM_i + 'NOT FIXED: Array.from is natively supported' + eol;
}
if (fixed._array.of) {
    msg += pM_i + 'FIXED: Added of factory method to Array' + eol;
}
else if ("of" in Array) {
    msg += pM_i + 'NOT FIXED: Array.of is natively supported' + eol;
}


/*if (fixed._array_generic.sliceFixed) {
    msg += pM_i + 'FIXED: Made Array.prototype.slice work with array-like objects' + eol;
}

// See whether any array generics have been added
var gMethods = [], gMethod;
for (gMethod in fixed._array_generic) {
    if (true === fixed._array_generic[gMethod] && "sliceFixed" !== gMethod) {
        gMethods.push(gMethod);
    }
}
if (gMethods.length) {
    msg += pM_i + 'FIXED: Added Array generics support (' + gMethods.length + ' methods)' + eol;
}
else {
    msg += pM_i + 'NOT FIXED: Array supports generic methods natively' + eol;
}*/

msg += eol;

if (fixed._array.isArray) {
    formatHdr('Array.isArray');

    testVal = Array.isArray([]);
    doTest('Array.isArray([]) === true', testVal, (testVal === true));

    testVal = Array.isArray(new Array());
    doTest('Array.isArray(new Array()) === true', testVal, (testVal === true));

    testVal = Array.isArray({});
    doTest('Array.isArray({}) === false', testVal, (testVal === false));
    msg += eol;
}

formatHdr('Find');
testBase = "UsefulJS.Array.find";
testVal = _A.find([], 1);
expected = -1;
doTest(testBase + '([], 1) === -1',
    testVal, testVal === expected);

var a = [1, 2, 3, 4, 2, 5, 6, 7, 8, 2, 9];
testInput = '[1, 2, 3, 4, 2, 5, 6, 7, 8, 2, 9]';
testVal = _A.find(a, 10);
expected = -1;
doTest(testBase + '(' + testInput + ', 10) === -1',
    testVal, testVal === expected);

testVal = _A.find(a, 10, null, -1);
doTest(testBase + '(' + testInput + ', 10, null, -1) === -1',
    testVal, testVal === expected);

testVal = _A.find(a, 1, a.length);
doTest(testBase + '(' + testInput + ', 1, a.length) === -1',
    testVal, testVal === expected);

testVal = _A.find(a, 1, -1 * (a.length + 1));
expected = 0;
doTest(testBase + '(' + testInput + ', 1, -1 * (a.length + 1)) === 0',
    testVal, testVal === expected);

testVal = _A.find(a, 2);
expected = 1;
doTest(testBase + '(' + testInput + ', 2) === 1',
    testVal, testVal === expected);

testVal = _A.find(a, 2, 1);
expected = 1;
doTest(testBase + '(' + testInput + ', 2, 1) === 1',
    testVal, testVal === expected);

testVal = _A.find(a, 2, 2);
expected = 4;
doTest(testBase + '(' + testInput + ', 2, 2) === 4',
    testVal, testVal === expected);

testVal = _A.find(a, 2, -1);
expected = -1;
doTest(testBase + '(' + testInput + ', 2, -1) === -1',
    testVal, testVal === expected);

testVal = _A.find(a, 9, -1);
expected = a.length - 1;
doTest(testBase + '(' + testInput + ', 9, -1) === ' + expected,
    testVal, testVal === expected);

testVal = _A.find(a, 2, -2);
expected = 9;
doTest(testBase + '(' + testInput + ', 2, -2) === ' + expected,
    testVal, testVal === expected);

testVal = _A.find(a, 1, -1 * (a.length + 1), -1);
expected = -1;
doTest(testBase + '(' + testInput + ', 1, -1 * ' + (a.length + 1) + ', -1) === ' + expected,
    testVal, testVal === expected);

testVal = _A.find(a, 2, null, -1);
expected = 9;
doTest(testBase + '(' + testInput + ', 2, null, -1) === ' + expected,
    testVal, testVal === expected);

testVal = _A.find(a, 2, -1, -1);
expected = 9;
doTest(testBase + '(' + testInput + ', 2, -1, -1) === ' + expected,
    testVal, testVal === expected);

testVal = _A.find(a, 2, a.length, -1);
expected = 9;
doTest(testBase + '(' + testInput + ', 2, ' + a.length + ', -1) === ' + expected,
    testVal, testVal === expected);

testVal = _A.find(a, 2, 8, -1);
expected = 4;
doTest(testBase + '(' + testInput + ', 2, 8, -1) === ' + expected,
    testVal, testVal === expected);

testVal = _A.find(a, 2, -12, -1);
expected = -1;
doTest(testBase + '(' + testInput + ', 2, -12, -1) === ' + expected,
    testVal, testVal === expected);


if (fixed._array.indexOf) {
    testVal = a.indexOf(2);
    expected = 1;
    doTest(testInput + '.indexOf(2) === ' + expected, testVal, testVal === expected);
}
if (fixed._array.lastIndexOf) {
    testVal = a.lastIndexOf(2);
    expected = 9;
    doTest(testInput + '.lastIndexOf(2) === ' + expected, testVal, testVal === expected);
}

msg += eol;

formatHdr('Iterate');

testBase = 'UsefulJS.Array.iterate';

thrown = false;
testInput = null;
p1 = function() { return true; };
try {
    _A.iterate(testInput, p1);
}
catch (e) {
    thrown = true;
}
doTest(testBase + '(' + testInput + ', ' + p1 + ') throws', thrown, thrown === true);

thrown = false;
try {
    _A.iterate([], "function");
}
catch (e) {
    thrown = true;
}
doTest(testBase + '([], "function") throws', thrown, thrown === true);

thrown = false;
try {
    _A.iterate([], function() {}, null, "unknown");
}
catch (e) {
    thrown = true;
}
doTest(testBase + '([], function() {}, null, "unknown") throws', thrown, thrown === true);

testVal = _A.iterate([], function() {}, null, "every");
expected = true;
doTest(testBase + '([], function() {}, null, "every") === true',
    testVal, testVal === expected);

testVal = _A.iterate([], function() {}, null, "some");
expected = false;
doTest(testBase + '([], function() {}, null, "some") === false',
    testVal, testVal === expected);

testVal = _typeof(_A.iterate([], function() {}, null, "map"));
expected = "array";
doTest('_typeof(' + testBase + '([], function() {}, null, "map")) === "' + expected + '"',
    testVal, testVal === expected);

testVal = _typeof(_A.iterate([], function() {}, null, "filter"));
expected = "array";
doTest('_typeof(' + testBase + '([], function() {}, null, "filter")) === "' + expected + '"',
    testVal, testVal === expected);

// Foreach, no context
count = 0;
a = [1, 2, 3, 4];
testInput = '[1, 2, 3, 4]';
ffE = function(item, idx, arr) { count = idx ? count + 1 : 1; };
_A.iterate(a, ffE, null, "forEach");
doTest(testBase + '(' + testInput + ', ' + eol + '    \t' + ffE + 
    ', null, "forEach") visits ' + a.length + ' items',
    count, count === a.length);


// forEach, perturb the array
a = [1, 2, 3, 4];
var countInitial = a.length;
ffE = function(item, idx, arr) { count = idx ? count + 1 : 1; arr.splice(arr.length - 1, 1); };
_A.iterate(a, ffE, null, "forEach");
doTest(testBase + '(' + testInput + ', ' + eol + '    \t' + ffE + ', ' + eol + 
    '    \t' + 'null, "forEach") visits ' + (countInitial / 2) + ' items',
    count, count === countInitial / 2);

// Visitor class for testing iteration with callback to a class instance
var Visitor = function() {
    this.visited = 0;
    this.visit = function(i, idx, a) {
        this.visited = idx ? this.visited + 1 : 1;
    };
    this.every_all = function(i, idx, a) {
        this.visit(i, idx, a);
        return true;
    };
    this.every_some = function(i, idx, a) {
        this.visit(i, idx, a);
        return (idx < (a.length - 2));
    };
    this.some_all = function(i, idx, a) {
        this.visit(i, idx, a);
        return false;
    };
    this.some_some = function(i, idx, a) {
        this.visit(i, idx, a);
        return (idx >= (a.length - 2));
    };
    this.filter_some = function(i, idx, a) {
        this.visit(i, idx, a);
        return (idx < (a.length - 1));
    };
    this.map = function(i, idx, a) {
        return i * i;
    };
};

a = [1, 2, 3, 4];
var visitor = new Visitor();

_A.iterate(a, visitor.visit, visitor, "forEach");
testVal = visitor.visited;
expected = a.length;
doTest(testBase + '(' + testInput + ', ' + visitor.visit + ', visitor, "forEach") visits ' + expected + ' items',
    testVal, testVal === expected);

// Iterate over a string
var testStr = "test";
_A.iterate(testStr, visitor.visit, visitor, "forEach");
testVal = visitor.visited;
expected = testStr.length;
doTest(testBase + '("' + testStr + '", ' + visitor.visit + ', visitor, "forEach") visits ' + expected + ' characters',
    testVal, testVal === expected);

var iRet;
expected = [a.length, true];
iRet = _A.iterate(a, visitor.every_all, visitor, "every");
testVal = visitor.visited;
doTest(testBase + '(' + testInput + ', ' + visitor.every_all + ', visitor, "every") visits ' + 
    expected[0] + ' items and returns ' + expected[1],
    [visitor.visited, iRet], (visitor.visited === expected[0] && iRet === expected[1]));

expected = [a.length - 1, false];
iRet = _A.iterate(a, visitor.every_some, visitor, "every");
doTest(testBase + '(' + testInput + ', ' + visitor.every_some + ', visitor, "every") visits ' + 
    expected[0] + ' items and returns ' + expected[1],
    [visitor.visited, iRet], (visitor.visited === expected[0] && iRet === expected[1]));

expected = [a.length, false];
iRet = _A.iterate(a, visitor.some_all, visitor, "some");
doTest(testBase + '(' + testInput + ', ' + visitor.some_all + ', visitor, "some") visits ' + 
    expected[0] + ' items and returns ' + expected[1],
    [visitor.visited, iRet], (visitor.visited === expected[0] && iRet === expected[1]));

expected = [a.length - 1, true];
iRet = _A.iterate(a, visitor.some_some, visitor, "some");
doTest(testBase + '(' + testInput + ', ' + visitor.some_some + ', visitor, "some") visits ' + 
    expected[0] + ' items and returns ' + expected[1],
    [visitor.visited, iRet], (visitor.visited === expected[0] && iRet === expected[1]));

expected = a.length;
iRet = _A.iterate(a, visitor.every_all, visitor, "filter");
doTest(testBase + '(' + testInput + ', ' + visitor.every_all + ', visitor, "filter") visits ' + 
    expected + ' items', iRet, iRet.length === expected);

expected = a.length - 1;
iRet = _A.iterate(a, visitor.filter_some, visitor, "filter");
doTest(testBase + '(' + testInput + ', ' + visitor.filter_some + ', visitor, "filter") visits ' + 
    expected + ' items', iRet, iRet.length === expected);

expected = [1, 4, 9, 16];
iRet = _A.iterate(a, visitor.map, visitor, "map");
doTest(testBase + '(' + testInput + ', ' + visitor.map + ', visitor, "map") visits ' + 
    expected.length + ' items and returns ' + expected,
    iRet, (iRet[0] === expected[0] && iRet[1] === expected[1] && 
        iRet[2] === expected[2] && iRet[3] === expected[3]));
        
var a2 = [1, 1, 1];
expected = undefined;
var evenFn = function(i, idx, a) { return !(i % 2); };
testVal = _A.iterate(a2, evenFn, null, "find");
doTest(testBase + '([' + a2.toString() + '], ' + evenFn + ', null, "find") === ' + expected,
    testVal, testVal === expected);
    
expected = -1;
testVal = _A.iterate(a2, evenFn, null, "findIndex");
doTest(testBase + '([' + a2.toString() + '], ' + evenFn + ', null, "findIndex") === ' + expected,
    testVal, testVal === expected);

a2[1] = 2;
expected = 2;
testVal = _A.iterate(a2, evenFn, null, "find");
doTest(testBase + '([' + a2.toString() + '], ' + evenFn + ', null, "find") === ' + expected,
    testVal, testVal === expected);
    
expected = 1;
testVal = _A.iterate(a2, evenFn, null, "findIndex");
doTest(testBase + '([' + a2.toString() + '], ' + evenFn + ', null, "findIndex") === ' + expected,
    testVal, testVal === expected);

if (fixed._array.forEach) {
    expected = a.length;
    a.forEach(visitor.visit, visitor);
    doTest(testInput + '.forEach(' + visitor.visit + ', visitor) visits ' + expected + ' items',
        visitor.visited, visitor.visited === expected);
}
if (fixed._array.every) {
    expected = [a.length - 1, false];
    iRet = a.every(visitor.every_some, visitor);
    doTest(testInput + '.every(' + visitor.every_some + ', visitor) visits ' + 
        expected[0] + ' items and returns ' + expected[1],
        [visitor.visited, iRet], (visitor.visited === expected[0] && iRet === expected[1]));
}
if (fixed._array.some) {
    expected = [a.length, false];
    iRet = a.some(visitor.some_all, visitor);
    doTest(testInput + '.some(' + visitor.some_all + ', visitor) visits ' + 
        expected[0] + ' items and returns ' + expected[1],
        [visitor.visited, iRet], (visitor.visited === expected[0] && iRet === expected[1]));
}
if (fixed._array.filter) {
    expected = a.length - 1;
    iRet = a.filter(visitor.filter_some, visitor);
    doTest(testInput + '.filter(' + visitor.filter_some + ', visitor) visits ' + expected + ' items',
        iRet, iRet.length === expected);
}
if (fixed._array.map) {
    expected = [1, 4, 9, 16];
    iRet = a.map(visitor.map, visitor);
    doTest(testInput + '.map(' + visitor.map + ', visitor) returns ' + expected,
        iRet, (iRet[0] === expected[0] && iRet[1] === expected[1] && 
            iRet[2] === expected[2] && iRet[3] === expected[3]));
    msg += eol;
}
if (fixed._array.find) {
    expected = 2;
    testVal = a2.find(evenFn);
    doTest('[' + a2.toString() + '].find(' + evenFn + ') === ' + expected,
        testVal, testVal === expected);
}
if (fixed._array.findIndex) {
    expected = 1;
    testVal = a2.findIndex(evenFn);
    doTest('[' + a2.toString() + '].findIndex(' + evenFn + ') === ' + expected,
        testVal, testVal === expected);
}

msg += eol;

formatHdr('Reduce');

var timesCalled = 0, total = 0, first = null;
var accFn = function(prev, curr, idx, arr) {
        ++timesCalled;
        if (null === first) {
            first = idx;
        }
        return prev + curr;
    };
a = [0, 1, 2, 3, 4];
testBase = "UsefulJS.Array.reduce";
testInput = '[0, 1, 2, 3, 4]';

thrown = false;
try {
    _A.reduce(null, accFn);
}
catch(e) {
    thrown = true;
}
doTest(testBase + '(null, ' + accFn + ') throws', thrown, thrown === true);

thrown = false;
try {
    _A.reduce(a, null);
}
catch(e) {
    thrown = true;
}
doTest(testBase + '(' + testInput + ', null) throws', thrown, thrown === true);

thrown = false;
try {
    _A.reduce([], accFn);
}
catch(e) {
    thrown = true;
}
doTest(testBase + '([], ' + accFn + ') throws', thrown, thrown === true);

testVal = _A.reduce([], accFn, 5);
expected = 5;
doTest(testBase + '([], ' + accFn + ', 5) === ' + expected,
    testVal, testVal === expected);

testVal = _A.reduce([2], accFn);
expected = 2;
doTest(testBase + '([2], ' + accFn + ') === ' + expected,
    testVal, testVal === expected);

testVal = _A.reduce([2], accFn, undefined, -1);
doTest(testBase + '([2], ' + accFn + ', undefined, -1) === ' + expected,
    testVal, testVal === expected);

timesCalled = 0;

testVal = [_A.reduce(a, accFn), timesCalled];
expected = [10, 4];
doTest(testBase + '(' + testInput + ', ' + accFn + ') called back ' + 
    expected[1] + ' times and returned ' + expected[0],
    testVal, (testVal[0] === expected[0] && testVal[1] === expected[1]));

timesCalled = 0;
first = null;
testVal = [_A.reduce(a, accFn, 5), timesCalled, first];
expected = [15, 5, a[0]];
doTest(testBase + '(' + testInput + ', ' + accFn + ', 5) called back ' + 
    expected[1] + ' times and returned ' + expected[0] + '; the first index visited was ' + expected[2],
    testVal, (testVal[0] === expected[0] && testVal[1] === expected[1] && testVal[2] === expected[2]));

timesCalled = 0;
first = null;
testVal = [_A.reduce(a, accFn, 5, -1), timesCalled, first];
expected = [15, 5, a[a.length - 1]];
doTest(testBase + '(' + testInput + ', ' + accFn + ', 5, -1) called back ' + 
    expected[1] + ' times and returned ' + expected[0] + '; the first index visited was ' + expected[2],
    testVal, (testVal[0] === expected[0] && testVal[1] === expected[1] && testVal[2] === expected[2]));

if (fixed._array.reduce) {
    timesCalled = 0;
    first = null;
    testVal = [a.reduce(accFn, 5), timesCalled, first];
    expected = [15, 5, a[0]];
    doTest(testInput + '.reduce(' + accFn + ', 5) called back ' + 
        expected[1] + ' times and returned ' + expected[0] + '; the first index visited was ' + expected[2],
        testVal, (testVal[0] === expected[0] && testVal[1] === expected[1] && testVal[2] === expected[2]));
}
if (fixed._array.reduceRight) {
    timesCalled = 0;
    first = null;
    testVal = [a.reduceRight(accFn, 5), timesCalled, first];
    expected = [15, 5, a[a.length - 1]];
    doTest(testInput + '.reduceRight(' + accFn + ', 5) called back ' + 
        expected[1] + ' times and returned ' + expected[0] + '; the first index visited was ' + expected[2],
        testVal, (testVal[0] === expected[0] && testVal[1] === expected[1] && testVal[2] === expected[2]));
}

msg += eol;

formatHdr('Fill');

testBase = 'UsefulJS.Array.fill';

thrown = false;
try {
    _A.fill();
}
catch(e) {
    thrown = true;
}
doTest(testBase + '() throws', thrown, thrown === true);

testInput = [];
p1 = null;
p2 = 0;
p3 = -1;
testVal = _A.fill(testInput, p1, p2, p3);
doTest(testBase + '([], ' + p1 + ', ' + p2 + ', ' + p3 + ') === []',
    testVal, testVal === testInput && 0 === testVal.length);

p2 = null;  
p3 = 1;
testInput.length = 1;
before = '[' + testInput.toString() + ']';
testVal = _A.fill(testInput, p1, p2, p3);
doTest(testBase + '([undefined]), ' + p1 + ', ' + p2 + ', ' + p3 + 
    ') === [null]',
    testVal, testVal === testInput && 1 === testVal.length && null === testVal[0]);
    
testInput.length = 3;
p1 = 1;
p2 = -1;
p3 = null;
testVal = _A.fill(testInput, p1, p2, p3);
doTest(testBase + '([null]), ' + p1 + ', ' + p2 + ', ' + p3 + 
    ') === [null,undefined,' + p1 + ']',
    testVal, testVal === testInput && undefined === testVal[1] && p1 === testVal[2]);

before = '[null,undefined,' + p1 + ']';   
p1 = 2;
testVal = _A.fill(testInput, p1);
expected = [2, 2, 2];
doTest(testBase + '(' + before +', ' + p1 + ') === [' + expected.toString() + ']',
    testVal, expected.toString() === testInput.toString());
    
before = '[' + expected.toString() + ']';
p1 = 3;
p2 = -2;
p3 = testVal.length;
expected = [2, 3, 3];
testVal = _A.fill(testInput, p1, p2, p3);
doTest(testBase + '(' + before +', ' + p1 + ', ' + p2 + ', ' + p3 + ') === [' + expected.toString() + ']',
    testVal, expected.toString() === testInput.toString());
    
testInput = { length : 3 };
before = '{"length":' + testInput.length + '}';
p1 = 3;
testVal = _A.fill(testInput, p1);
doTest(testBase + '(' + before +', ' + p1 + ') === {"0":3,"1",3,"2":3,"length":3}',
    testVal, testVal === testInput && testVal[0] === 3 && testVal[1] === 3 && testVal[2] === 3);
    
if (fixed._array.fill) {
    p1 = 3;
    testInput = Array(p1);
    testVal = testInput.fill(p1);
    expected = [3,3,3];
    doTest('Array(' + p1 +').fill(' + p1 + ') === [' + expected.toString() + ']',
        testVal, testVal === testInput && expected.toString() === testVal.toString());
}

msg += eol;

if (fixed._array.copyWithin) {
    formatHdr('Array.prototype.copyWithin tests');
    
    testInput = 0;
    p1 = 3;
    testVal = [1, 2, 3, 4, 5].copyWithin(testInput, p1);
    expected = [4, 5, 3, 4, 5];
    doTest('[1, 2, 3, 4, 5].copyWithin(' + testInput + ', ' + p1 + ') === [4, 5, 3, 4, 5]',
        testVal, testVal.toString() === expected.toString());
        
    p2 = 4;
    testVal = [1, 2, 3, 4, 5].copyWithin(testInput, p1, p2);
    expected = [4, 2, 3, 4, 5];
    doTest('[1, 2, 3, 4, 5].copyWithin(' + testInput + ', ' + p1 + ', ' + p2 + ') === [4, 2, 3, 4, 5]',
        testVal, testVal.toString() === expected.toString());
        
    p1 = -2;
    p2 = -1;
    testVal = [1, 2, 3, 4, 5].copyWithin(testInput, p1, p2);
    expected = [4, 2, 3, 4, 5];
    doTest('[1, 2, 3, 4, 5].copyWithin(' + testInput + ', ' + p1 + ', ' + p2 + ') === [4, 2, 3, 4, 5]',
        testVal, testVal.toString() === expected.toString());
        
    var cwObj = {length : 5, 3 : "a"};
    testInput = 0;
    p1 = 3;
    testVal = Array.prototype.copyWithin.call(cwObj, testInput, p1);
    doTest('Array.prototype.copyWithin.call({length : 5, 3 : "a"}, ' + 
        testInput + ', ' + p1 + ') === {length : 3, 0 : "a", 3 : "a"}',
        [testVal.length, testVal["0"], testVal["3"]], 
        testVal.length === 5 && testVal["0"] === "a" && testVal["3"] === "a");
    
    msg += eol;
}

if (fixed._array.from) {
    formatHdr('Array.from tests');

    testInput = "𐌀𐌁𐌂";
    testVal = Array.from(testInput);
    expected = ['𐌀', '𐌁', '𐌂'];
    doTest('Array.from("' + testInput + '") === [\'𐌀\', \'𐌁\', \'𐌂\']',
        testVal, testVal.toString() === expected.toString());
        
    testInput = {"0":1, "1":2, length:2};
    testVal = Array.from(testInput);
    expected = [1, 2];
    doTest('Array.from({"0":1, "1":2, length:2}) === [1, 2]',
        testVal, testVal.toString() === expected.toString());
        
    testVal = Array.from(testInput, function(item, idx) { return item * 2; });
    expected = [2, 4];
    doTest('Array.from({"0":1, "1":2, length:2}, function(item, idx) { return item * 2; }) === [2, 4]',
        testVal, testVal.toString() === expected.toString());
        
    testVal = Array.from(testInput, function(item, idx) { return item * this.mul; }, {mul : 3});
    expected = [3, 6];
    doTest('Array.from({"0":1, "1":2, length:2}, function(item, idx) { return item * this.mul; }' + 
        ', {mul : 3}) === [3, 6]', testVal, testVal.toString() === expected.toString());
        
    var FromArray = function FromArray(l) { this.length = l; this.id = "A"; };
    FromArray.prototype = new Array();
    FromArray.from = Array.from;
    testVal = FromArray.from(testInput);
    doTest("Array.from constructs the correct return value type", testVal.id, testVal.id === "A");
    
    msg += eol; 
}

if (fixed._array.of) {
    formatHdr('Array.of tests');
    
    testVal = Array.of();
    expected = [];
    doTest('Array.of() === []',
        testVal, Array.isArray(expected) && !expected.length);
        
    testInput = undefined;
    testVal = Array.of(undefined);
    expected = [undefined];
    doTest('Array.of(' + testInput + ') === [' + testInput + ']',
        testVal, Array.isArray(expected) && 1 === expected.length && undefined === expected[0]);
        
    testInput = 1;
    p1 = "2";
    p2 = [3];
    testVal = Array.of(testInput, p1, p2);
    expected = [1, "2", [3]];
    doTest('Array.of(' + testInput + ', "' + p1 + '", [' + p2[0] + ']) === ' + 
        '[' + testInput + ', "' + p1 + '", [' + p2[0] + ']]', testVal, 
        testVal.toString() === expected.toString());
        
    var OfArray = function OfArray(l) { this.length = l; this.id = "A"; };
    OfArray.prototype = new Array();
    OfArray.of = Array.of;
    testVal = OfArray.of();
    doTest("Array.of constructs the correct return value type", testVal.id, testVal.id === "A");
    
    msg += eol; 
}
    

/*if (fixed._array_generic.sliceFixed) {
    formatHdr('Array.prototype.slice tests');
    testInput = "abc";
    testVal = Array.prototype.slice.call(testInput, 1, null);
    expected = ['b', 'c'];
    doTest('Array.prototype.slice works on strings',
        testVal, testVal.toString() === expected.toString());

    testInput = document.getElementsByTagName("pre");
    testVal = Array.prototype.slice.call(testInput, 0, 1);
    expected = [document.getElementById("testOutput")];
    doTest('Array.prototype.slice works on NodeList objects',
        testVal, testVal[0] === expected[0]);
    msg += eol;
}

if (gMethods.length) {
    formatHdr('Array generics tests');
    testInput = "abc";
    if (fixed._array_generic.join) {
        testVal = Array.join(testInput, "-");
        expected = "a-b-c";
        doTest('Array.join works on a String', testVal, testVal === expected);
    }
    if (fixed._array_generic.slice) {
        testVal = Array.slice(testInput, 1);
        expected = ['b', 'c'];
        doTest('Array.slice works on a String', testVal, 
            testVal.toString() === expected.toString());
    }
    if (fixed._array_generic.indexOf) {
        testVal = Array.indexOf(testInput, "b");
        expected = 1;
        doTest('Array.indexOf works on a String', testVal, testVal === expected);
    }
    if (fixed._array_generic.every) {
        testVal = "";
        Array.every(testInput, function(c) {
            if ('c' === c) {
                return false;
            }
            testVal += c;
            return true;
        });
        expected = "ab";
        doTest('Array.every works on a String', testVal, testVal === expected);
    }
    if (fixed._array_generic.some) {
        testVal = "";
        Array.some(testInput, function(c) {
            if ('c' === c) {
                return true;
            }
            testVal += c;
            return false;
        });
        expected = "ab";
        doTest('Array.some works on a String', testVal, testVal === expected);
    }
    if (fixed._array_generic.forEach) {
        testVal = "";
        Array.forEach(testInput, function(c) {
            testVal += c;
        });
        expected = "abc";
        doTest('Array.forEach works on a String', testVal, testVal === expected);
    }
    if (fixed._array_generic.filter) {
        testVal = Array.filter(testInput, function(c) {
            if (c === 'c') {
                return false;
            }
            return true;
        });
        expected = ['a', 'b'];
        doTest('Array.filter works on a String', testVal,
            testVal.toString() === expected.toString());
    }
    if (fixed._array_generic.map) {
        testVal = Array.map(testInput, function(c) {
            return c.toUpperCase();
        });
        expected = ['A', 'B', 'C'];
        doTest('Array.map works on a String', testVal,
            testVal.toString() === expected.toString());
    }
    if (fixed._array_generic.reduce) {
        testVal = Array.reduce(testInput, function(s, c) {
            s = s || "";
            return s + c;
        });
        expected = "abc";
        doTest('Array.reduce works on a String', testVal, testVal === expected);
    }
    if (fixed._array_generic.reduceRight) {
        testVal = Array.reduceRight(testInput, function(s, c) {
            s = s || "";
            return s + c;
        });
        expected = "cba";
        doTest('Array.reduceRight works on a String', testVal, testVal === expected);
    }
};

msg += eol + eol;*/
msg += eol;

var _M = UsefulJS.Math;
testBase = 'UsefulJS.Math';
formatHdr(testBase);

msg += eol;

var mathFns = "acosh asinh atanh cbrt clz32 cosh expm1 fround hypot imul log1p log10 log2 sign sinh tanh trunc".split(' ').forEach(function(func) {
    if (fixed._math[func]) {
        msg += pM_i + 'FIXED: ' + func + ' static method added to Math' + eol;
    }
    else if (func in Math) {
        msg += pM_i + 'NOT FIXED: ' + func + ' is natively supported' + eol;
    }
    else {
        msg += pM_i + 'NOT FIXED: ' + func + ' cannot be implemented' + eol;
    }
});

msg += eol;

formatHdr('fcorrect tests');

testVal = _M.fcorrect(Math.log(1e9) / Math.LN10);
expected = 9;
doTest(testBase + '.fcorrect(Math.log(1e9) / Math.LN10)) === ' + expected,
    testVal, testVal === expected);

testVal = _M.fcorrect(Math.tan(Math.PI / 4));
expected = 1;
doTest(testBase + '.fcorrect(Math.tan(Math.PI / 4)) === ' + expected,
    testVal, testVal === expected);

testVal = _M.fcorrect(0.2 + 0.1, 1);
expected = 0.3;
doTest(testBase + '.fcorrect(0.2 + 0.1, 1) === ' + expected,
    testVal, testVal === expected);

msg += eol;

formatHdr('logn tests');

thrown = false;
try {
    _M.logn(2, -1);
}
catch(e) {
    thrown = true;
}
doTest(testBase + '.logn(2, -1) throws', thrown, (thrown === true));

testVal = _M.logn(0, 0);
doTest('isNaN(' + testBase + '.logn(0, 0))', testVal, isNaN(testVal));

testVal = _M.logn(1, 1);
doTest('isNaN(' + testBase + '.logn(1, 1))', testVal, isNaN(testVal));

testVal = _M.logn(2, 1);
doTest(testBase + '.logn(2, 1) === Number.POSITIVE_INFINITY', testVal,
    (testVal === Number.POSITIVE_INFINITY));

testVal = _M.logn(0, 1);
doTest(testBase + '.logn(0, 1) === Number.NEGATIVE_INFINITY', testVal,
    (testVal === Number.NEGATIVE_INFINITY));

testVal = _M.logn(1, 2);
doTest(testBase + '.logn(1, 2) === 0', testVal,
    (testVal === 0));

testVal = _M.logn(256, 16);
doTest(testBase + '.logn(256, 16) === 2', testVal, 
    testVal === 2);
    
testInput = 1000000000000000;
p1 = 10;
testVal = _M.logn(testInput, p1);
expected = 15;
doTest(testBase + '.logn(' + testVal + ', ' + p1 + ') === ' + expected, 
    testVal, testVal === expected);

msg += eol;

formatHdr('Angle conversion tests');

thrown = false;
try {
    _M.rad(Number.NaN);
}
catch(e) {
    thrown = true;
}
doTest(testBase + '.rad(Number.NaN) throws', thrown, thrown === true);

thrown = false;
try {
    _M.rad(Number.POSITIVE_INFINITY);
}
catch(e) {
    thrown = true;
}
doTest(testBase + '.rad(Number.POSITIVE_INFINITY) throws', thrown, thrown === true);

thrown = false;
try {
    _M.rad("A");
}
catch(e) {
    thrown = true;
}
doTest(testBase + '.rad("A") throws', thrown, thrown === true);

thrown = false;
try {
    _M.rad({});
}
catch(e) {
    thrown = true;
}
doTest(testBase + '.rad({}) throws', thrown, thrown === true);

var almostEqual = function(a, b) {
    return Math.abs(a - b) < 1e-5;
}, cFn = _M.fcorrect;

testVal = _M.rad(0);
expected = 0;
doTest(testBase + '.rad(0) === 0',
    testVal, testVal === expected);

testVal = Math.tan(_M.rad(45));
expected = 1;
doTest('Math.tan(' + testBase + '.rad(45)) =~ 1',
    testVal, cFn(testVal) === expected);

testVal = Math.tan(_M.rad(-45));
expected = -1;
doTest('Math.tan(' + testBase + '.rad(-45)) =~ -1',
    testVal, cFn(testVal) === expected);

testVal = Math.tan(_M.rad(44, 59, 59));
expected = 1;
doTest('Math.tan(' + testBase + '.rad(44, 59, 59)) =~ 1',
    testVal, almostEqual(testVal, expected));

testVal = Math.tan(_M.rad(44, 119, 119));
expected = 1;
doTest('Math.tan(' + testBase + '.rad(44, 119, 119)) =~ 1',
    testVal, almostEqual(testVal, expected));

testVal = Math.tan(_M.rad(44.99999));
expected = 1;
doTest('Math.tan(' + testBase + '.rad(44.99999)) =~ 1',
    testVal, almostEqual(testVal, expected));

thrown = false;
try {
    _M.deg(Number.NaN);
}
catch(e) {
    thrown = true;
}
doTest(testBase + '.deg(Number.NaN) throws', thrown, thrown === true);

testVal = _M.deg(0);
expected = 0;
doTest(testBase + '.deg(0) === 0', testVal, testVal === 0);

testVal = Math.tan(_M.rad(_M.deg(Math.PI / 4)));
expected = 1;
doTest('Math.tan(' + testBase + '.rad(' + testBase + '.deg(Math.PI / 4))) =~ 1',
    testVal, cFn(testVal) === expected);

testVal = Math.tan(_M.rad(_M.deg(-Math.PI / 4)));
expected = -1;
doTest('Math.tan(' + testBase + '.rad(' + testBase + '.deg(-Math.PI / 4))) =~ -1',
    testVal, cFn(testVal) === expected);

testVal = _M.dms(_M.rad(44, 59, 59));
expected = [44, 59, 59];
doTest(testBase + '.dms(' + testBase + '.rad(44, 59, 59)) === [44, 59, 59]',
    testVal, testVal.toString() === expected.toString());
    
msg += eol;

if (fixed._math.acosh) {
    formatHdr('acosh tests');
    testInput = 0;
    testVal = Math.acosh(testInput);
    expected = Number.NaN;
    doTest('Math.acosh(' + testInput + ') === ' + expected,
        testVal, isNaN(testVal));
        
    testInput = 1;
    testVal = Math.acosh(testInput);
    expected = 0;
    doTest('Math.acosh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = (Math.E + 1/Math.E) / 2;
    testVal = Math.acosh(testInput);
    expected = 1;
    doTest('Math.acosh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    msg += eol;
}
    
if (fixed._math.asinh) {
    formatHdr('asinh tests');
    testInput = 0;
    testVal = Math.asinh(testInput);
    expected = 0;
    doTest('Math.asinh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = (Math.E - 1/Math.E) / 2;
    testVal = Math.asinh(testInput);
    expected = 1;
    doTest('Math.asinh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = (1/Math.E - Math.E) / 2;
    testVal = Math.asinh(testInput);
    expected = -1;
    doTest('Math.asinh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1e-16;
    testVal = Math.asinh(testInput);
    expected = 1e-16;
    doTest('Math.asinh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    msg += eol;
}

if (fixed._math.atanh) {
    formatHdr('atanh tests');
    
    testInput = 1.5;
    testVal = Math.atanh(testInput);
    expected = Number.NaN;
    doTest('Math.atanh(' + testInput + ') === ' + expected,
        testVal, isNaN(testVal));
    
    testInput = 1;
    testVal = Math.atanh(testInput);
    expected = Number.POSITIVE_INFINITY;
    doTest('Math.atanh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = -1.5;
    testVal = Math.atanh(testInput);
    expected = Number.NaN;
    doTest('Math.atanh(' + testInput + ') === ' + expected,
        testVal, isNaN(testVal));

    testInput = -1;
    testVal = Math.atanh(testInput);
    expected = Number.NEGATIVE_INFINITY;
    doTest('Math.atanh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 0.7615941559557649;
    testVal = Math.atanh(testInput);
    expected = 1;
    doTest('Math.atanh(' + testInput + ') === ' + expected,
        testVal, UsefulJS.Math.fcorrect(testVal, 0) === expected);
    
    testInput = -0.7615941559557649;
    testVal = Math.atanh(testInput);
    expected = -1;
    doTest('Math.atanh(' + testInput + ') === ' + expected,
        testVal, UsefulJS.Math.fcorrect(testVal, 0) === expected);
    
    testInput = 1e-16;
    testVal = Math.atanh(testInput);
    expected = 1e-16;
    doTest('Math.atanh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    msg += eol;
    
}
    
if (fixed._math.cbrt) {
    formatHdr('cbrt tests');
    
    testInput = 27;
    testVal = Math.cbrt(testInput);
    expected = 3;
    doTest('Math.cbrt(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = -27;
    testVal = Math.cbrt(testInput);
    expected = -3;
    doTest('Math.cbrt(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    msg += eol;
}

if (fixed._math.clz32) {
    formatHdr('clz32 tests');
    
    testInput = Math.pow(2, 32);
    testVal = Math.clz32(testInput);
    expected = 32;
    doTest('Math.clz32(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = Math.pow(2, 32) - 1;
    testVal = Math.clz32(testInput);
    expected = 0;
    doTest('Math.clz32(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = Math.pow(2, 31);
    testVal = Math.clz32(testInput);
    expected = 0;
    doTest('Math.clz32(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = Math.pow(2, 30);
    testVal = Math.clz32(testInput);
    expected = 1;
    doTest('Math.clz32(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = Math.pow(2, 16);
    testVal = Math.clz32(testInput);
    expected = 15;
    doTest('Math.clz32(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 3;
    testVal = Math.clz32(testInput);
    expected = 30;
    doTest('Math.clz32(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1;
    testVal = Math.clz32(testInput);
    expected = 31;
    doTest('Math.clz32(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    msg += eol;
}

if (fixed._math.cosh) {
    formatHdr('cosh tests');
    
    testInput = 0;
    testVal = Math.cosh(testInput);
    expected = 1;
    doTest('Math.cosh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1;
    testVal = Math.cosh(testInput);
    expected = (Math.E + 1/Math.E) / 2;
    doTest('Math.cosh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);

    testInput = -1;
    testVal = Math.cosh(testInput);
    expected = (Math.E + 1/Math.E) / 2;
    doTest('Math.cosh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = 1e-16;
    testVal = Math.cosh(testInput);
    expected = 1;
    doTest('Math.cosh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    msg += eol;
}

if (fixed._math.expm1) {
    formatHdr('expm1 tests');
    
    testInput = 0;
    testVal = Math.expm1(testInput);
    expected = 0;
    doTest('Math.expm1(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1e-16;
    testVal = Math.expm1(testInput);
    expected = 0;
    doTest('Math.expm1(' + testInput + ') > ' + expected,
        testVal, testVal > expected);
    
    msg += eol;
}

if (fixed._math.fround) {
    formatHdr('fround tests');
    
    testVal = Math.fround();
    expected = Number.NaN;
    doTest('Math.fround() === ' + expected,
        testVal, isNaN(testVal));
        
    testInput = null;
    testVal = Math.fround(testInput);
    expected = 0;
    doTest('Math.fround(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = Number.POSITIVE_INFINITY;
    testVal = Math.fround(testInput);
    expected = Number.POSITIVE_INFINITY;
    doTest('Math.fround(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1e40;
    testVal = Math.fround(testInput);
    expected = Number.POSITIVE_INFINITY;
    doTest('Math.fround(' + testInput + ') === ' + expected,
        testVal, testVal === expected);

    testInput = 1e-46;
    testVal = Math.fround(testInput);
    expected = 0;
    doTest('Math.fround(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 0.1;
    testVal = Math.fround(testInput);
    doTest('Math.fround(' + testInput + ') !== ' + testInput,
        testVal, testVal !== testInput);
    
    msg += eol;
}

if (fixed._math.hypot) {
    formatHdr('hypot tests');
    
    testVal = Math.hypot();
    expected = 0;
    doTest('Math.hypot() === ' + expected,
        testVal, testVal === expected);
    
    testInput = 1;
    p1 = Number.NaN;    
    testVal = Math.hypot(testInput, p1);
    expected = Number.NaN;
    doTest('Math.hypot(' + testInput + ', ' + p1 + ') === ' + expected,
        testVal, isNaN(testVal));
        
    testInput = 1;
    p1 = Number.POSITIVE_INFINITY;    
    testVal = Math.hypot(testInput, p1);
    expected = Number.POSITIVE_INFINITY;
    doTest('Math.hypot(' + testInput + ', ' + p1 + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1;
    p1 = Number.NEGATIVE_INFINITY;    
    testVal = Math.hypot(testInput, p1);
    expected = Number.POSITIVE_INFINITY;
    doTest('Math.hypot(' + testInput + ', ' + p1 + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 0;
    testVal = Math.hypot(testInput);
    expected = 0;
    doTest('Math.hypot(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 0;
    p1 = 0;
    testVal = Math.hypot(testInput, p1);
    expected = 0;
    doTest('Math.hypot(' + testInput + ', ' + p1 + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = -2;
    testVal = Math.hypot(testInput);
    expected = 2;
    doTest('Math.hypot(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 3;
    p1 = -4;
    testVal = Math.hypot(testInput, p1);
    expected = 5;
    doTest('Math.hypot(' + testInput + ', ' + p1 + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 3;
    p1 = -4;
    testVal = Math.hypot(testInput, 0, 0, p1);
    expected = 5;
    doTest('Math.hypot(' + testInput + ', 0, 0, ' + p1 + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1e160;
    p1 = 1e160;
    testVal = Math.hypot(testInput, p1);
    expected = Math.SQRT2 * 1e160;
    doTest('Math.hypot(' + testInput + ', ' + p1 + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1e-160;
    p1 = 1e-160;
    testVal = Math.hypot(testInput, p1);
    expected = Math.SQRT2 * 1e-160;
    doTest('Math.hypot(' + testInput + ', ' + p1 + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 3;
    p1 = -4;
    p2 = 5;
    testVal = Math.hypot(testInput, p1, p2);
    expected = Math.sqrt(50);
    doTest('Math.hypot(' + testInput + ', ' + p1 + ', ' + p2 + ') === ' + expected,
        testVal, testVal === expected);
        
    msg += eol;
}

if (fixed._math.imul) {
    formatHdr('imul tests');
    
    testInput = 2;
    p1 = Number.NaN;
    testVal = Math.imul(testInput, p1);
    expected = 0;
    doTest('Math.imul(' + testInput + ', ' + p1 + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = 2;
    p1 = 2;
    testVal = Math.imul(testInput, p1);
    expected = 4;
    doTest('Math.imul(' + testInput + ', ' + p1 + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = 2;
    p1 = -2;
    testVal = Math.imul(testInput, p1);
    expected = -4;
    doTest('Math.imul(' + testInput + ', ' + p1 + ') === ' + expected,
        testVal, testVal === expected);

    testInput = -2;
    p1 = -2;
    testVal = Math.imul(testInput, p1);
    expected = 4;
    doTest('Math.imul(' + testInput + ', ' + p1 + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = 0xdeadBeef;
    p1 = 0xdeadbeef;
    testVal = Math.imul(testInput, p1);
    expected = 560833313;
    doTest('Math.imul(0x' + testInput.toString(16) + ', 0x' + p1.toString(16) + ') === 0x' + expected.toString(16),
        testVal, testVal === expected);
        
    testInput = 0xffffffff;
    p1 = 0xfffffffe;
    testVal = Math.imul(testInput, p1);
    expected = 2;
    doTest('Math.imul(0x' + testInput.toString(16) + ', 0x' + p1.toString(16) + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 0xffffffff;
    p1 = 2;
    testVal = Math.imul(testInput, p1);
    expected = -2;
    doTest('Math.imul(0x' + testInput.toString(16) + ', ' + p1 + ') === ' + expected,
        testVal, testVal === expected);
        
    msg += eol;
}

if (fixed._math.log1p) {
    formatHdr('log1p tests');
    
    testVal = Math.log1p();
    doTest('Math.log1p() === ' + Number.NaN,
        testVal, isNaN(testVal));
        
    testInput = 0;
    testVal = Math.log1p(testInput);
    expected = 0;
    doTest('Math.log1p(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1e-16;
    testVal = Math.log1p(testInput);
    expected = 0;
    doTest('Math.log1p(' + testInput + ') > ' + expected,
        testVal, testVal > expected);
    
    
    msg += eol;
}

if (fixed._math.log10) {
    formatHdr('log10 tests');
    
    testVal = Math.log10();
    doTest('Math.log10() === ' + Number.NaN,
        testVal, isNaN(testVal));
        
    testInput = Number.POSITIVE_INFINITY;
    testVal = Math.log10(testInput);
    expected = testInput;
    doTest('Math.log10(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 0;
    testVal = Math.log10(testInput);
    expected = Number.NEGATIVE_INFINITY;
    doTest('Math.log10(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1;
    testVal = Math.log10(testInput);
    expected = 0;
    doTest('Math.log10(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 10;
    testVal = Math.log10(testInput);
    expected = 1;
    doTest('Math.log10(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1e9;
    testVal = Math.log10(testInput);
    expected = 9;
    doTest('Math.log10(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1e-9;
    testVal = Math.log10(testInput);
    expected = -9;
    doTest('Math.log10(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    msg += eol;
}
    
if (fixed._math.log2) {
    formatHdr('log2 tests');
    
    testVal = Math.log2();
    doTest('Math.log2() === ' + Number.NaN,
        testVal, isNaN(testVal));
        
    testInput = 1;
    testVal = Math.log2(testInput);
    expected = 0;
    doTest('Math.log2(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 2;
    testVal = Math.log2(testInput);
    expected = 1;
    doTest('Math.log2(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1024;
    testVal = Math.log2(testInput);
    expected = 10;
    doTest('Math.log2(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1/1024;
    testVal = Math.log2(testInput);
    expected = -10;
    doTest('Math.log2(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1 << 29;
    testVal = Math.log2(testInput);
    expected = 29;
    doTest('Math.log2(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    msg += eol;
}

if (fixed._math.sign) {
    formatHdr('sign tests');
    
    testVal = Math.sign();
    doTest('Math.sign() === ' + Number.NaN,
        testVal, isNaN(testVal));
        
    testInput = 0;
    testVal = Math.sign(testInput);
    expected = 0;
    doTest('Math.sign(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = -0;
    testVal = Math.sign(testInput);
    expected = -0;
    doTest('Math.sign(-' + testInput + ') === -' + expected,
        testVal, Object.is(testVal, expected));
    
    testInput = 1;
    testVal = Math.sign(testInput);
    expected = 1;
    doTest('Math.sign(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = -1;
    testVal = Math.sign(testInput);
    expected = -1;
    doTest('Math.sign(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    msg += eol;
}    
    
if (fixed._math.sinh) {
    formatHdr('sinh tests');
    
    testInput = 0;
    testVal = Math.sinh(testInput);
    expected = 0;
    doTest('Math.sinh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1e-16;
    testVal = Math.sinh(testInput);
    expected = 1e-16;
    doTest('Math.sinh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);

    testInput = -1;
    testVal = Math.sinh(testInput);
    expected = (1/Math.E - Math.E) / 2;
    doTest('Math.sinh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = 1;
    testVal = Math.sinh(testInput);
    expected = ( Math.E - 1/Math.E) / 2;
    doTest('Math.sinh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    msg += eol;

}

if (fixed._math.tanh) {
    formatHdr('tanh tests');
    
    testInput = Number.NaN;
    testVal = Math.tanh(testInput);
    expected = Number.NaN;
    doTest('Math.tanh(' + testInput + ') === ' + expected,
        testVal, isNaN(testVal));
    
    testInput = Number.POSITIVE_INFINITY;
    testVal = Math.tanh(testInput);
    expected = 1;
    doTest('Math.tanh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = Number.NEGATIVE_INFINITY;
    testVal = Math.tanh(testInput);
    expected = -1;
    doTest('Math.tanh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = 0;
    testVal = Math.tanh(testInput);
    expected = 0;
    doTest('Math.tanh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1;
    testVal = Math.tanh(testInput);
    expected = 0.7615941559557649;
    doTest('Math.tanh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = -1;
    testVal = Math.tanh(testInput);
    expected = -0.7615941559557649;
    doTest('Math.tanh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = 1e-16;
    testVal = Math.tanh(testInput);
    expected = 1e-16;
    doTest('Math.tanh(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    msg += eol;
}

if (fixed._math.trunc) {
    formatHdr('trunc tests');
    
    testVal = Math.trunc();
    doTest('Math.trunc() === ' + Number.NaN,
        testVal, isNaN(testVal));
        
    testInput = Number.POSITIVE_INFINITY;
    testVal = Math.trunc(testInput);
    expected = Number.POSITIVE_INFINITY;
    doTest('Math.trunc(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
    
    testInput = 0.5;
    testVal = Math.trunc(testInput);
    expected = 0;
    doTest('Math.trunc(' + testInput + ') === ' + expected,
        testVal, testVal === expected);
        
    testInput = -0.5;
    testVal = Math.trunc(testInput);
    expected = -0;
    doTest('Math.trunc(' + testInput + ') === -' + expected,
        testVal, Object.is(testVal, expected));
    
    testInput = -0;
    testVal = Math.trunc(testInput);
    expected = -0;
    doTest('Math.trunc(-' + testInput + ') === -' + expected,
        testVal, Object.is(testVal, expected));
    
    msg += eol;
}    


msg += eol;

testBase = 'UsefulJS.Number';
var _N = _u.Number;
formatHdr(testBase);

if (fixed._number.EPSILON) {
    msg += pM_i + 'FIXED: Added EPSILON property to Number, ' + Number.EPSILON + eol;
}
else if ("EPSILON" in Number) {
    msg += pM_i + 'NOT FIXED: Number.EPSILON is natively supported'+ eol;
}
if (fixed._number.MAX_SAFE_INTEGER) {
    msg += pM_i + 'FIXED: Added MAX_SAFE_INTEGER property to Number, ' + Number.MAX_SAFE_INTEGER + eol;
}
else if ("MAX_SAFE_INTEGER" in Number) {
    msg += pM_i + 'NOT FIXED: Number.MAX_SAFE_INTEGER is natively supported'+ eol;
}
if (fixed._number.MIN_SAFE_INTEGER) {
    msg += pM_i + 'FIXED: Added MIN_SAFE_INTEGER property to Number, ' + Number.MIN_SAFE_INTEGER + eol;
}
else if ("MIN_SAFE_INTEGER" in Number) {
    msg += pM_i + 'NOT FIXED: Number.MIN_SAFE_INTEGER is natively supported'+ eol;
}
if (fixed._number._toFixed) {
    msg += pM_i + 'FIXED: Added _toFixed method to Number.prototype' + eol;
}
else if ("_toFixed" in Number.prototype) {
    msg += pM_i + 'NOT FIXED: Number.prototype._toFixed is natively supported'+ eol;
}
if (fixed._number.toLocaleStringFixed) {
    msg += pM_i + 'FIXED: Patched toLocaleString method of Number.prototype to support language tags and format options' + eol;
}
else {
    testVal = (0.1).toLocaleString("en", { style : "percent" });
    if ("10%" === testVal) {
        msg += pM_i + 'NOT FIXED: Number.prototype.toLocaleString natively supports language tags and format options'+ eol;
    }
}
if (fixed._number.intl_NumberFormat) {
    msg += pM_i + 'FIXED: Added Intl.NumberFormat to the global context' + eol;
}
else if ("Intl" in window && "NumberFormat" in window.Intl) {
    msg += pM_i + 'NOT FIXED: Intl.NumberFormat is natively supported' + eol;
}

msg += eol;

var crAlg = _N.rounding;

if (fixed._number._toFixed) {

    formatHdr('_toFixed tests (ROUND_HALF_TOWARDS_EVEN)');
    
    _N.rounding = _N.ROUND_HALF_TOWARDS_EVEN;

    testVal = Number.NaN._toFixed();
    expected = "NaN";
    doTest('Number.NaN._toFixed() === "' + expected + '"',
        testVal, testVal === expected);

    testVal = Number.POSITIVE_INFINITY._toFixed();
    expected = "Infinity";
    doTest('Number.POSITIVE_INFINITY._toFixed() === "' + expected + '"',
        testVal, testVal === expected);

    testVal = Number.NEGATIVE_INFINITY._toFixed();
    expected = "-Infinity";
    doTest('Number.NEGATIVE_INFINITY._toFixed() === "' + expected + '"',
        testVal, testVal === expected);

    testVal = Math.PI._toFixed();
    expected = "3";
    doTest('Math.PI._toFixed() === "' + expected + '"',
        testVal, testVal === expected);

    testVal = Math.PI._toFixed("2");
    expected = "3";
    doTest('Math.PI._toFixed("2") === "' + expected + '"',
        testVal, testVal === expected);

    testVal = Math.PI._toFixed(-1);
    expected = "3";
    doTest('Math.PI._toFixed(-1) === "' + expected + '"',
        testVal, testVal === expected);

    testVal = Math.PI._toFixed(1);
    expected = "3.1";
    doTest('Math.PI._toFixed(1) === "' + expected + '"',
        testVal, testVal === expected);

    testVal = Math.PI._toFixed(1, 2);
    expected = "3.1";
    doTest('Math.PI._toFixed(1, 2) === "' + expected + '"',
        testVal, testVal === expected);

    testVal = (3)._toFixed(3, 0);
    expected = "3";
    doTest('(3)._toFixed(3) === "' + expected + '"',
        testVal, testVal === expected);

    testVal = (3)._toFixed(3, 3);
    expected = "3.000";
    doTest('(3)._toFixed(3, 3) === "' + expected + '"',
        testVal, testVal === expected);

    testVal = (-9999.95)._toFixed(1);
    expected = "-10000";
    doTest('(-9999.95)._toFixed(1) === "' + expected + '"',
        testVal, testVal === expected);

    testVal = Math.PI._toFixed(13);
    expected = "3.1415926535898";
    doTest('(Math.PI)._toFixed(13) === "' + expected + '"',
        testVal, testVal === expected);
        
    testVal = (0.5)._toFixed();
    expected = "0";
    doTest('(0.5)._toFixed() === "' + expected + '"',
        testVal, testVal === expected);

    testVal = (-0.5)._toFixed();
    expected = "0";
    doTest('(-0.5)._toFixed() === "' + expected + '"',
        testVal, testVal === expected);

    testVal = (-1.5)._toFixed();
    expected = "-2";
    doTest('(-1.5)._toFixed() === "' + expected + '"',
        testVal, testVal === expected);
        
    testVal = (2.25)._toFixed(1);
    expected = "2.2";
    doTest('(2.25)._toFixed(1) === "' + expected + '"',
        testVal, testVal === expected);
        
    testVal = (-1.25e-21)._toFixed(22);
    expected = "-0.0000000000000000000012";
    doTest('(-1.25e-21)._toFixed(22) === "' + expected + '"',
        testVal, testVal === expected);

    msg += eol;
    
    formatHdr('_toFixed tests (ROUND_HALF_TO_PLUS_INFINITY)');
        
    _N.rounding = _N.ROUND_HALF_TO_PLUS_INFINITY;
    
    testVal = (-9999.95)._toFixed(1);
    expected = "-9999.9";
    doTest('(-9999.95)._toFixed(1) === "' + expected + '"',
        testVal, testVal === expected);

    testVal = (-1.5)._toFixed();
    expected = "-1";
    doTest('(-1.5)._toFixed() === "' + expected + '"',
        testVal, testVal === expected);

    testVal = (2.25)._toFixed(1);
    expected = "2.3";
    doTest('(2.25)._toFixed(1) === "' + expected + '"',
        testVal, testVal === expected);

    testVal = (-1.25e-21)._toFixed(22);
    expected = "-0.0000000000000000000012";
    doTest('(-1.25e-21)._toFixed(22) === "' + expected + '"',
        testVal, testVal === expected);
    
    msg += eol;
    
    formatHdr('_toFixed tests (ROUND_HALF_AWAY_FROM_ZERO)');
        
    _N.rounding = _N.ROUND_HALF_AWAY_FROM_ZERO;
    
    testVal = (-9999.95)._toFixed(1);
    expected = "-10000";
    doTest('(-9999.95)._toFixed(1) === "' + expected + '"',
        testVal, testVal === expected);

    testVal = (-1.5)._toFixed();
    expected = "-2";
    doTest('(-1.5)._toFixed() === "' + expected + '"',
        testVal, testVal === expected);

    testVal = (2.25)._toFixed(1);
    expected = "2.3";
    doTest('(2.25)._toFixed(1) === "' + expected + '"',
        testVal, testVal === expected);

    testVal = (-1.25e-21)._toFixed(22);
    expected = "-0.0000000000000000000013";
    doTest('(-1.25e-21)._toFixed(22) === "' + expected + '"',
        testVal, testVal === expected);
    
    msg += eol;
    
}

_N.rounding = crAlg;


testBase = "UsefulJS.Number.Format";
formatHdr(testBase + ': Option resolution');
var _NF = _N.Format;

var testObj = new _NF();
testInput = testObj.resolvedOptions();
testVal = [testInput.locale, testInput.numberingSystem, testInput.style, testInput.minimumFractionDigits,
    testInput.maximumFractionDigits, testInput.minimumIntegerDigits, testInput.minimumSignificantDigits,
    testInput.maximumSignificantDigits, testInput.useGrouping];
expected = [_u.Locale.current, "latn", "decimal", 0, 3, 1, undefined, undefined, true];
doTest('Expected locale and defaults set', testVal,
    testVal.toString() === expected.toString());

testObj = new _NF(["quz-PE", "es-PE", "es"]);
testInput = testObj.resolvedOptions();
testVal = testInput.locale;
expected = "es-PE";
doTest('Locale resolved', testVal, testVal === expected);

testObj = new _NF("ar");
testInput = testObj.resolvedOptions();
testVal = testInput.numberingSystem;
expected = "arab";
doTest('Default alternate number system resolved', testVal, testVal === expected);

testObj = new _NF("zh-Hant-TW-u-nu-hanidec");
testInput = testObj.resolvedOptions();
testVal = testInput.numberingSystem;
expected = "hanidec";
doTest('Alternate number system from u-nu extension resolved', testVal, testVal === expected);

testObj = new _NF("en", { minimumSignificantDigits : 4, maximumSignificantDigits : 3, minimumIntegerDigits : 5 });
testInput = testObj.resolvedOptions();
testVal = [testInput.minimumSignificantDigits, testInput.maximumSignificantDigits, testInput.minimumIntegerDigits];
expected = [4, 4, 1];
doTest('Significant digits are orthogonal to other properties', testVal,
    testVal.toString() === expected.toString());

msg += eol;

formatHdr(testBase + ': Basic number formatting');
var nOpts;

// Save the current locale and set to "en"
var cL = _u.Locale.current;
_u.Locale.current = "en";

testObj = new _NF("en");
testVal = testObj.format("1");
expected = "1";
doTest('format("1") === "' + expected + '"',
    testVal, testVal === expected);

testVal = testObj.format(Number.NaN);
expected = "NaN";
doTest('format(Number.NaN) === "' + expected + '"', 
    testVal, testVal === expected);

testVal = testObj.format(1000000);
expected = "1,000,000";
doTest('format(1000000) === "' + expected + '"', 
    testVal, testVal === expected);

testVal = testObj.format(10000.0111);
expected = "10,000.011";
doTest('format(10000.0111) === "' + expected + '"', 
    testVal, testVal === expected);

testObj = new _NF("fr");
testVal = testObj.format(10000.011);
expected = "10\u00a0000,011";
doTest('{locale : fr}, format(10000.011) === "' + expected + '"', 
    testVal, testVal === expected);

nOpts = { maximumFractionDigits : 2 };
testObj = new _NF("en", nOpts);
testVal = testObj.format(10000.011);
expected = "10,000.01";
doTest('{maximumFractionDigits : 2}, format(10000.011) === "' + expected + '"', 
    testVal, testVal === expected);

testVal = testObj.format(10000.1);
expected = "10,000.1";
doTest('{maximumFractionDigits : 2}, format(10000.1) === "' + expected + '"', 
    testVal, testVal === expected);

nOpts = { maximumFractionDigits : 0 };
testObj = new _NF("en", nOpts);
testVal = testObj.format(-9999.5);
expected = "-10,000";
doTest('{maximumFractionDigits : 0}, format(-9999.5) === "' + expected + '"', 
    testVal, testVal === expected);

nOpts = { minimumFractionDigits : 4 };
testObj = new _NF("en", nOpts);
testVal = testObj.format(10000.011);
expected = "10,000.0110";
doTest('{minimumFractionDigits : 4}, format(10000.011) === "' + expected + '"', 
    testVal, testVal === expected);

nOpts = { minimumIntegerDigits : 7 };
testObj = new _NF("en", nOpts);
testVal = testObj.format(10000.011);
expected = "0,010,000.011";
doTest('{minimumIntegerDigits : 7}, format(10000.011) === "' + expected + '"', 
    testVal, testVal === expected);

nOpts = { maximumSignificantDigits : 6 };
testObj = new _NF("en", nOpts);
testVal = testObj.format(118865432);
expected = "118,865,000";
doTest('{maximumSignificantDigits : 6}, format(118865432) === "' + expected + '"', 
    testVal, testVal === expected);

nOpts = { minimumSignificantDigits : 6 };
testObj = new _NF("en", nOpts);
testVal = testObj.format(1188);
expected = "1,188.00";
doTest('{minimumSignificantDigits : 6}, format(1188) === "' + expected + '"', 
    testVal, testVal === expected);

nOpts = { minimumSignificantDigits : 6, useGrouping : false };
testObj = new _NF("en", nOpts);
testVal = testObj.format(1188);
expected = "1188.00";
doTest('{minimumSignificantDigits : 6, useGrouping : false}, format(1188) === "' + expected + '"', 
    testVal, testVal === expected);

// Small numbers
testObj = new _NF("en");
testVal = testObj.format(0.0019);
expected = "0.002";
doTest('format(0.0019) === "' + expected + '"', 
    testVal, testVal === expected);

testVal = testObj.format(-0.0019, nOpts);
expected = "-0.002";
doTest('format(-0.0019) === "' + expected + '"', 
    testVal, testVal === expected);

testObj = new _NF("fr");
testVal = testObj.format(-0.0015);
expected = "-0,002";
doTest('{locale : "fr"}, format(-0.0015) === "' + expected + '"', 
    testVal, testVal === expected);

nOpts = { maximumSignificantDigits : 6 };
testObj = new _NF("en", nOpts);
testVal = testObj.format(0.0118865432);
expected = "0.0118865";
doTest('{maximumSignificantDigits : 6}, format(0.0118865432) === "' + expected + '"', 
    testVal, testVal === expected);

nOpts = { minimumSignificantDigits : 6 };
testObj = new _NF("en", nOpts);
testVal = testObj.format(0.01188);
expected = "0.0118800";
doTest('{minimumSignificantDigits : 6}, format(0.01188) === "' + expected + '"', 
    testVal, testVal === expected);

// Unusual grouping
testObj = new _NF("en-IN");
testVal = testObj.format(_N.MAX_INT);
expected = '99,99,99,99,99,99,999';
doTest('{locale : "en-IN"}, format(' + _N.MAX_INT + ') === "' + expected + '"',
    testVal, testVal === expected);

testObj = new _NF();
testVal = [1, 2].map(testObj.format);
expected = ["1", "2"];
doTest(testBase + '.format method bound to instance',
    testVal, testVal.toString() === expected.toString());

msg += eol;

if (fixed._number.toLocaleStringFixed) {
    formatHdr('Number.prototype.toLocaleString');
    testVal = (2001).toLocaleString("zh-u-nu-hanidec", { useGrouping : false });
    expected = "二〇〇一";
    doTest('(2001).toLocaleString("zh-u-nu-hanidec", { useGrouping : false }) === "' + expected + '"',
        testVal, testVal === expected);
    msg += eol;
}

formatHdr(testBase + ': Scientific / engineering notation');

_u.Locale.current = "en";
var sOpts = { style : "scientific" };
testObj = new _NF("en", sOpts);
testVal = testObj.format(0);
expected = "0";
doTest('format(0) === "' + expected + '"',
    testVal, testVal === expected);

testVal = testObj.format(1);
expected = "1";
doTest('format(1) === "' + expected + '"',
    testVal, testVal === expected);

testVal = testObj.format(9.99);
expected = "9.99";
doTest('format(9.99) === "' + expected + '"',
    testVal, testVal === expected);

testVal = testObj.format(999.99);
expected = "10³";
doTest('format(999.99) === "' + expected + '"',
    testVal, testVal === expected);

sOpts.maximumFractionDigits = 4;
testObj = new _NF("en", sOpts);
testVal = testObj.format(999.99);
expected = "9.9999" + _N._sep + "10²";
doTest('{maximumFractionDigits : 4}, format(999.99) === "' + expected + '"',
    testVal, testVal === expected);

sOpts = { style : "scientific", maximumSignificantDigits : 5 };
testObj = new _NF("en", sOpts);
testVal = testObj.format(999.99);
expected = "9.9999" + _N._sep + "10²";
doTest('{maximumSignificantDigits : 5}, format(999.99) === "' + expected + '"',
    testVal, testVal === expected);


sOpts = { style : "scientific"};
testObj = new _NF("en", sOpts);
testVal = testObj.format(1000000000);
expected = "10⁹";
doTest('format(1000000000) === "' + expected + '"',
    testVal, testVal === expected);

testVal = testObj.format(0.000000001);
expected = "10⁻⁹";
doTest('format(0.000000001) === "' + expected + '"',
    testVal, testVal === expected);

testInput = -1.2e-9;
testVal = testObj.format(testInput);
expected = "-1.2" + _N._sep + "10⁻⁹";
doTest('format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

sOpts.keep1 = true;
testObj = new _NF("en", sOpts);
testInput = 1000000000;
testVal = testObj.format(testInput);
expected = "1" + _N._sep + "10⁹";
doTest('{keep1 : true}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

sOpts.keep1 = false;
sOpts.minimumSignificantDigits = 3;
testObj = new _NF("en", sOpts);
testInput = 1000000000;
testVal = testObj.format(testInput);
expected = "1.00" + _N._sep + "10⁹";
doTest('{minimumSignificantDigits : 3}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

sOpts = { style : "engineering" };
testObj = new _NF("en", sOpts);
testInput = 0.000000125;
testVal = testObj.format(testInput);
expected = "125" + _N._sep + "10⁻⁹";
doTest('{style : "engineering"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = 0.0000000125;
testVal = testObj.format(testInput);
expected = "12.5" + _N._sep + "10⁻⁹";
doTest('{style : "engineering"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = 12500000;
testVal = testObj.format(testInput);
expected = "12.5" + _N._sep + "10⁶";
doTest('{style : "engineering"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = 125000000;
testVal = testObj.format(testInput);
expected = "125" + _N._sep + "10⁶";
doTest('{style : "engineering"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

msg += eol;

formatHdr(testBase + ': Scaled values');
nOpts = { style : "siunits", scale : "auto" };
testObj = new _NF("en", nOpts);
testVal = testObj.format(1000);
expected = '1\u00a0k';
doTest('format(1000) === "' + expected + '"',
    testVal, testVal === expected);

testVal = testObj.format(1000000);
expected = '1\u00a0M';
doTest('format(1000000) === "' + expected + '"',
    testVal, testVal === expected);

testVal = testObj.format(1000000000);
expected = '1\u00a0G';
doTest('format(1000000000) === "' + expected + '"',
    testVal, testVal === expected);

nOpts.maximumFractionDigits = 2;
testObj = new _NF("en", nOpts);
testVal = testObj.format(1015000000);
expected = '1.02\u00a0G';
doTest('{maximumFractionDigits : 2}, format(1015000000) === "' + expected + '"',
    testVal, testVal === expected);

testVal = testObj.format(-1005000000);
expected = '-1\u00a0G';
doTest('{maximumFractionDigits : 2}, format(-1005000000) === "' + expected + '"',
    testVal, testVal === expected);

testVal = testObj.format(-1016000000);
expected = '-1.02\u00a0G';
doTest('{maximumFractionDigits : 2}, format(-1016000000) === "' + expected + '"',
    testVal, testVal === expected);

msg += eol;

formatHdr(testBase + ': SI format');
var cOpts = { style : "siunits", scale : "auto", SI : true };
// Units
// Kilograms are a special case
cOpts.unit = "kilogram";
testObj = new _NF("en", cOpts);

testInput = 1.2;
testVal = testObj.format(testInput);
expected = "1.2\u00a0kg";
doTest('{unit : "kilogram"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = 1200;
testVal = testObj.format(testInput);
expected = "1\u00a0200\u00a0kg";
doTest('{unit : "kilogram"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = 0.001;
testVal = testObj.format(testInput);
expected = "0.001\u00a0kg";
doTest('{unit : "kilogram"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = 0.000001;
testVal = testObj.format(testInput);
expected = "1\u00a0mg";
doTest('{unit : "kilogram"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

cOpts.scale = "micro";
testObj = new _NF("en", cOpts);
testVal = testObj.format(testInput);
expected = "1\u00a0000\u00a0µg";
doTest('{unit : "kilogram", scale : "micro"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

cOpts.scale = "";
cOpts.style = "scientific";
testObj = new _NF("en", cOpts);
testVal = testObj.format(testInput);
expected = "10⁻⁶\u00a0kg";
doTest('{unit : "kilogram", scale : "", style : "scientific" }, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

// Celsius scale should be fixed at 1
cOpts.scale = "m";
cOpts.unit = "celsius";
delete(cOpts.style);

testObj = new _NF("en", cOpts);
testInput = -0.001;
testVal = testObj.format(testInput);
expected = "-0.001\u00a0°C";
doTest('{unit : "celsius", scale : "m"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = 0;
testVal = testObj.format(testInput);
expected = "0\u00a0°C";
doTest('{unit : "celsius", scale : "m"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

// Degrees of arc are shown with the unit adjacent to the value
cOpts.unit = "degree";
testObj = new _NF("en", cOpts);
testInput = 60;
testVal = testObj.format(testInput);
expected = "60°";
doTest('{unit : "degree", scale : "m"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

// Ångstrom has a fixed scale of 1e-10
cOpts.unit = "angstrom";
testObj = new _NF("en", cOpts);
testInput = 1.2e-10;
testVal = testObj.format(testInput);
expected = "1.2\u00a0Å";
doTest('{unit : "angstrom", scale : "m"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

cOpts.scale = "auto";
cOpts.unit = "metre second-1";
testObj = new _NF("en", cOpts);
testInput = 299792458;
testVal = testObj.format(testInput);
expected = "299\u00a0792.458\u00a0km·s⁻¹";
doTest('{unit : "metre second-1", scale : "auto"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

// Length will be expressed in cm when this is the most appropriate measure
cOpts.unit = "metre";
testInput = 0.15;
testObj = new _NF("en", cOpts);
testVal = testObj.format(testInput);
expected = "15\u00a0cm";
doTest('{unit : "metre", scale : "auto"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

// Compound units
cOpts = {
    style : "siunits",
    unit : "metre+3",
    scale : "c",
    SI : true
};
testObj = new _NF("en", cOpts);
testInput = 1;
testVal = testObj.format(testInput);
expected = "1\u00a0000\u00a0000\u00a0cm³";
doTest('{unit : "metre", scale : "c"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = 6.67384e-11;
cOpts.unit = "metre+3 kilogram-1 second-2";
cOpts.maximumSignificantDigits = 6;
cOpts.scale = "auto";
testObj = new _NF("en", cOpts);

testVal = testObj.format(testInput);
expected = "66\u00a0738\u00a0400\u00a0µm³·kg⁻¹·s⁻²";
doTest('{ maximumSignificantDigits : 6, scale : "auto", unit : "metre+3 kilogram-1 second-2"}, format(' + testInput + 
    ') === "' + expected + '"',
    testVal, testVal === expected);

cOpts.scale = "";
delete(cOpts.maximumSignificantDigits);
cOpts.maximumSignificantDigits = 6;
cOpts.style = "scientific";
testObj = new _NF("en", cOpts);
testVal = testObj.format(testInput);
expected = "6.67384\u00a0×\u00a010⁻¹¹\u00a0m³·kg⁻¹·s⁻²";
doTest('{ maximumSignificantDigits : 6, scale : "", unit : "metre+3 kilogram-1 second-2"}, format(' + testInput + 
    ') === "' + expected + '"',
    testVal, testVal === expected);

cOpts.unit = "newton (m/kg)+2";
testObj = new _NF("en", cOpts);
testVal = testObj.format(testInput);
expected = "6.67384\u00a0×\u00a010⁻¹¹\u00a0N·(m/kg)²";
doTest('{ maximumSignificantDigits : 6, scale : "", unit : "newton (m/kg)+2"}, format(' + testInput + 
    ') === "' + expected + '"',
    testVal, testVal === expected);

delete(cOpts.maximumFractionDigits);

// Byte output
cOpts.unit = "bytes";
cOpts.scale = "auto";

testInput = (1 << 2);
testObj = new _NF("en", cOpts);
testVal = testObj.format(testInput);
expected = "4\u00a0B";
doTest('{unit : "bytes", scale : "auto"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = (1 << 11);
testVal = testObj.format(testInput);
expected = "2\u00a0KB";
doTest('{unit : "bytes", scale : "auto"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = (1 << 22);
testVal = testObj.format(testInput);
expected = "4\u00a0MB";
doTest('{unit : "bytes", scale : "auto"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = (1 << 30) * 8;
testVal = testObj.format(testInput);
expected = "8\u00a0GB";
doTest('{unit : "bytes", scale : "auto"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

cOpts.scale = "k";
testObj = new _NF("en", cOpts);
testInput = 2560;
testVal = testObj.format(testInput);
expected = "2.5\u00a0KB";
doTest('{unit : "bytes", scale : "k"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

cOpts.base10 = true;
testObj = new _NF("en", cOpts);
testInput = 2500;
testVal = testObj.format(testInput);
expected = "2.5\u00a0KB";
doTest('{unit : "bytes", scale : "k", base10 : true}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);


msg += eol;

formatHdr(testBase + ': Currency format');

thrown = false;
try {
    (new _NF("en", { style : "currency" })).format(1);
}
catch(e) {
    thrown = true;
}
doTest("Missing currency option throws", thrown, thrown === true);

nOpts = { style : "currency", currency : "USD" };

testObj = new _NF("en", nOpts);
testInput = 2.227;
testVal = testObj.format(testInput);
expected = "$2.23";
doTest('format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

testInput = -2.225;
testVal = testObj.format(testInput);
expected = "($2.22)";
doTest('format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);
    
testInput = -2.215;
testVal = testObj.format(testInput);
expected = "($2.22)";
doTest('format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);
    
crAlg = _N.rounding;
_N.rounding = _N.ROUND_HALF_AWAY_FROM_ZERO;
testInput = -2.225;
testVal = testObj.format(testInput);
expected = "($2.23)";
doTest('format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);
_N.rounding = crAlg;

nOpts.currency = "CHF";
testObj = new _NF("de-CH", nOpts);
testInput = -1122.225;
testVal = testObj.format(testInput);
expected = "Fr.-1'122,20";
doTest('{locale : "de-CH"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

nOpts.currency = "JPY";
testObj = new _NF("ja", nOpts);
testInput = 1122.225;
testVal = testObj.format(testInput);
expected = "￥1,122";
doTest('{locale : "ja"}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

msg += eol;

formatHdr(testBase + ': Percent format');

nOpts = { style : "percent" };
testObj = new _NF("en", nOpts);
testInput = 0.85;
testVal = testObj.format(testInput);
expected = "85%";
doTest('format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

nOpts.maximumSignificantDigits = 6;
testObj = new _NF("tr", nOpts);
testInput = -11.75345;
testVal = testObj.format(testInput);
expected = "-%\u00a01.175,35";
doTest('{locale : "tr", maximumSignificantDigits : 6}, format(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

msg += eol;

formatHdr('UsefulJS.Number.Format: parse tests');

var _NP = UsefulJS.Number.Format;
testObj = new _NP();
testVal = testObj.parse();
doTest('isNaN(' + 'parse()) === true', testVal,
    isNaN(testVal));

testVal = testObj.parse("");
doTest('isNaN(' + 'parse("")) === true', testVal,
    isNaN(testVal));

testVal = testObj.parse({});
doTest('isNaN(' + 'parse("")) === true', testVal,
    isNaN(testVal));

testVal = testObj.parse(1);
doTest('parse(1) === 1', testVal, testVal === 1);

testVal = testObj.parse("-1.0e-10");
doTest('parse("-1.0e-10") === parseFloat("-1.0e-10")',
    testVal, testVal === parseFloat("-1.0e-10"));

testVal = testObj.parse("∞");
doTest('parse("∞") === Number.POSITIVE_INFINITY',
    testVal, testVal === Number.POSITIVE_INFINITY);

testVal = testObj.parse("-∞");
doTest('parse("-∞") === Number.NEGATIVE_INFINITY',
    testVal, testVal === Number.NEGATIVE_INFINITY);

testVal = testObj.parse("999,999,999,999,999");
doTest('parse("999,999,999,999,999") === ' + _N.MAX_INT,
    testVal, testVal === _N.MAX_INT);

testVal = testObj.parse("-999,999,999,999,999");
doTest('parse("-999,999,999,999,999") === ' + (-1 * _N.MAX_INT),
    testVal, testVal === -1 * _N.MAX_INT);

testObj = new _NP("fr"); 
testVal =  testObj.parse("10\u00a0000,01");
expected = Number("10000.01");
doTest('{locale : "fr"}, ' + 'parse("10\\u00a0000,01") === ' + expected,
    testVal, testVal === expected);

testVal =  testObj.parse("16\u00a0TB");
expected = (1 << 22) * (1 << 22);
doTest('parse("16\u00a0TB") === ' + expected,
    testVal, testVal === expected);

// Byte units parsed as base10 values
testObj = new _NP(null, { base10 : true });
testVal =  testObj.parse("16\u00a0TB");
expected = 1.6e13;
doTest('{ base10 : true }, parse("16\u00a0TB") === ' + expected,
    testVal, testVal === expected);

testInput = "-1.2\u00a0×\u00a010⁻⁹";
testVal = testObj.parse(testInput);
expected = -1.2e-9;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

testInput = "125\u00a0×\u00a010⁻⁹";
testVal = testObj.parse(testInput);
expected = 1.25e-7;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

// Deka scale (scale value is two characters)
testInput = "10\u00a0dam";
testVal = testObj.parse(testInput);
expected = 100;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

testInput = "10\u00a0dag";
testVal = testObj.parse(testInput);
expected = 0.1;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

// Check that we don't incorrectly scale kg
testInput = "10\u00a0kg";
testVal = testObj.parse(testInput);
expected = 10;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

// Angle units
testInput = "10°";
testVal = testObj.parse(testInput);
expected = 10;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

testInput = "10\u2032";
testVal = testObj.parse(testInput);
expected = 10;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

testInput = "10\u2033";
testVal = testObj.parse(testInput);
expected = 10;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

// Ambiguous unit - Gray not giga-year
testInput = "15\u00a0Gy";
testVal = testObj.parse(testInput);
expected = 15;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

// Disambiguate with a unit
testObj = new _NP(null, { unit : "year" });
testVal = testObj.parse(testInput);
expected = 1.5e10;
doTest('{unit : "year"}, parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

testObj = new _NP(null, { unit : "katal+1 mole-1" });
testInput = "15\u00a0kat·mol⁻¹";
testVal = testObj.parse(testInput);
expected = 15;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);
testObj = new _NP();

// Compound units
testInput = "6.67384\u00a0×\u00a010⁻¹¹\u00a0m³·kg⁻¹·s⁻²";
testVal = testObj.parse(testInput);
expected = 6.67384e-11;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

testInput = "66 738 400\u00a0µm³·kg⁻¹·s⁻²";
testVal = testObj.parse(testInput);
expected = 6.67384e-11;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

// Taking the scale of the unit into account
testInput = "1\u00a0Zm³"; // Cubic zetametre
testVal = testObj.parse(testInput);
expected = 1e63;
doTest('parse("' + testInput + '") === ' + expected,
    testVal, testVal === expected);

nOpts = { style : "currency", currency : "USD" };
testObj = new _NP("en", nOpts);
testVal = testObj.parse("($22.55)");
expected = -22.55;
doTest('parse("($22.55)") === ' + expected,
    testVal, testVal === expected);

nOpts.currency = "EUR";
testObj = new _NP("fr", nOpts);
testVal = testObj.parse("1\u00a0025,45\u00a0€");
expected = 1025.45;
doTest('{locale : "fr"}, ' + 'parse("1\u00a0025,45\u00a0€") === ' + expected,
    testVal, testVal === expected);

msg += eol + eol;

formatHdr('UsefulJS.ClassList');

var _C = _u.featureSupport.classList;
if (_C.supported) {
    if (fixed._classList.classList) {
        msg += pM_i + 'FIXED: Added classList to Element.prototype' + eol;
        if (_C.settable) {
            msg += pM_i + 'FIXED: classList supports the DOMSettableTokenList interface' + eol;
        }
    }
    else if (_C.nativeSupport) {
        msg += pM_i + 'NOT FIXED: classList is natively supported' + eol;
        if (_C.settable) {
            msg += pM_i + "DOMSettableTokenList interface is natively supported" + eol;
        }
        else {
            msg += pM_i + "DOMSettableTokenList interface is not natively supported" + eol;
        }
    }
}
else {
    msg += pM_i + 'NOT FIXED: It is not possible to implement classList on this system\n\t' +
        ' - use UsefulJS.ClassList.get to obtain a DOMTokenList for an element' + eol;
}

msg += eol;
_C = UsefulJS.ClassList;
// DOMTokenList tests
formatHdr('DOMTokenList interface');

testBase = '(new UsefulJS.ClassList("testOutput"))';
var classList = new UsefulJS.ClassList(p);

classList.add("cl1", "cl2");
testVal = p.className;
expected = "cl1 cl2";
doTest(testBase + '.add("cl1", "cl2") -> "' + expected + '"',
    testVal, testVal == expected);

testVal = classList.length;
expected = 2;
doTest(testBase + '.length === ' + expected,
    testVal, testVal == expected);

// Array-like indexing
testVal = classList[0];
expected = "cl1";
doTest(testBase + '[0] === "' + expected + '"',
    testVal, testVal == expected);

testVal = classList[1];
expected = "cl2";
doTest(testBase + '[1] === "' + expected + '"',
    testVal, testVal == expected);

if (_u.featureSupport.defineProperty) {
    try {
        // May throw in strict mode
        classList.length = 1;
    }
    catch(e) {}
    testVal = classList.length;
    expected = 2;
    doTest(testBase + '.length is read-only',
        testVal, testVal == expected);
}

p.className = " cl3 cl1 cl2 cl3  cl4 ";
testVal = classList.toString();
expected = p.className;
doTest(testBase + '.toString() === "' + expected + '"',
    testVal, testVal == expected);

classList.remove("cl3", "cl4");
testVal = p.className;
expected = "cl1 cl2";
doTest(testBase + '.remove("cl3", "cl4") -> "' + expected + '"',
    testVal, testVal == expected);

testVal = classList.toggle("cl2");
expected = "cl1";
doTest(testBase + '.toggle("cl2") -> "' + expected + '"',
    [testVal, p.className], testVal == false && p.className === expected);

// Toggle force parameter: false (remove but don't add)
testVal = classList.toggle("cl2", false);
expected = "cl1";
doTest(testBase + '.toggle("cl2", false) -> "' + expected + '"',
    [testVal, p.className], testVal == false && p.className === expected);

testVal = classList[1];
expected = undefined;
doTest(testBase + '[1] === ' + expected,
    testVal, testVal == expected);

testVal = classList.toggle("cl2");
expected = "cl1 cl2";
doTest(testBase + '.toggle("cl2") -> "' + expected + '"',
    [testVal, p.className], testVal == true && p.className === expected);

// Toggle force parameter: true (add but don't remove)
testVal = classList.toggle("cl2", true);
expected = "cl1 cl2";
doTest(testBase + '.toggle("cl2", true) -> "' + expected + '"',
    [testVal, p.className], testVal == true && p.className === expected);

testVal = classList[1];
expected = "cl2";
doTest(testBase + '[1] === "' + expected + '"',
    testVal, testVal == expected);

testVal = classList.contains("cl2")
expected = true;
doTest(testBase + '.contains("cl2") === ' + expected,
    testVal, testVal == expected);

testVal = classList.contains("cl3")
expected = false;
doTest(testBase + '.contains("cl3") === ' + expected,
    testVal, testVal == expected);

testVal = classList.item(0);
expected = "cl1";
doTest(testBase + '.item(0) === "' + expected + '"',
    testVal, testVal === expected);

testVal = classList.item(2);
expected = null;
doTest(testBase + '.item(2) === ' + expected,
    testVal, testVal === expected);
    
var obj = {
    csv : "1,2,3"
};
classList = new _C(obj, "csv", ",");
classList.add("4");
classList.remove("2");
expected = "1,3,4";
testVal = obj.csv;
doTest("UsefulJS.ClassList works with separators other than ' '",
    testVal, testVal === expected);    

msg += eol;

if ("value" in classList) {
    // DOMSettableTokenList
    classList = new _C(p);
    formatHdr('DOMSettableTokenList interface');
    testVal = classList.value;
    expected = "cl1 cl2";
    doTest(testBase + '.value === "' + expected + '"',
        testVal, testVal === expected);

    classList.value = "";
    testVal = p.className;
    expected = "";
    doTest(testBase + '.value is read-write and sets the underlying className',
        testVal, testVal === expected);
    msg += eol;
}


formatHdr('classList tests');

testVal = _C.get("testOutput");
doTest('UsefulJS.ClassList.get("testOutput") !== null',
    testVal, testVal !== null);

if (fixed._classList.classList) {
    testBase = 'document.getElementById("testOutput").classList';
    classList = p.classList;
    p.className = "";

    classList.add("cl1", "cl2");
    testVal = p.className;
    expected = "cl1 cl2";
    doTest(testBase + '.add("cl1", "cl2") -> "' + expected + '"',
        testVal, testVal === expected);

    p.className = " cl3 cl1 cl2 cl3  cl4 ";
    testVal = classList.toString();
    expected = p.className;
    doTest(testBase + '.toString() === "' + expected + '"',
        testVal, testVal === expected);

    classList.remove("cl3", "cl4");
    testVal = p.className;
    expected = "cl1 cl2";
    doTest(testBase + '.remove("cl3", "cl4") -> "' + expected + '"',
        testVal, testVal === expected);

    p.className = "cl1 cl2";
    testVal = classList.toggle("cl2");
    expected = "cl1";
    doTest(testBase + '.toggle("cl2") -> "' + expected + '"',
        [testVal, p.className], testVal === false && p.className === expected);

    testVal = classList.toggle("cl2", false);
    expected = "cl1";
    doTest(testBase + '.toggle("cl2", false) -> "' + expected + '"',
        [testVal, p.className], testVal === false && p.className === expected);

    testVal = classList.toggle("cl2");
    expected = "cl1 cl2";
    doTest(testBase + '.toggle("cl2") -> "' + expected + '"',
        [testVal, p.className], testVal === true && p.className === expected);

    testVal = classList.toggle("cl2", true);
    expected = "cl1 cl2";
    doTest(testBase + '.toggle("cl2", true) -> "' + expected + '"',
        [testVal, p.className], testVal === true && p.className === expected);

    testVal = classList.contains("cl2");
    expected = true;
    doTest(testBase + '.contains("cl2") === ' + expected,
        testVal, testVal === expected);

    testVal = classList.contains("cl3");
    expected = false;
    doTest(testBase + '.contains("cl3") === ' + expected,
        testVal, testVal === expected);

    testVal = p.classList.item(0);
    expected = "cl1";
    doTest(testBase + '.item(0) === "' + expected + '"',
        testVal, testVal === expected);

    testVal = p.classList.item(2);
    expected = null;
    doTest(testBase + '.item(2) === ' + expected,
        testVal, testVal === expected);

    if ("value" in classList) {
        // DOMSettableTokenList
        testVal = classList.value;
        expected = p.className;
        doTest(testBase + '.value === "' + expected + '"',
            testVal, testVal === expected);

        classList.value = "";
        testVal = p.className;
        expected = "";
        doTest(testBase + '.value = "" -> ""',
            testVal, testVal === expected);
    }
}
msg += eol + eol;

formatHdr('UsefulJS.String');

if (_u.featureSupport.string.codePointEscaping) {
    msg += pM_i + "This browser supports codepoint (\\u{...}) escape sequences" + eol;
}
else {
    msg += pM_i + "This browser only supports \\uXXXX or \\xx escape sequences" + eol;
}
if (fixed._string.includes) {
    msg += pM_i + "FIXED: Added includes method to String prototype" + eol;
}
else if ("includes" in String.prototype) {
    msg += pM_i + "NOT FIXED: String.prototype.includes is natively supported" + eol;
}
if (fixed._string.startsWith) {
    msg += pM_i + "FIXED: Added startsWith method to String prototype" + eol;
}
else if ("startsWith" in String.prototype) {
    msg += pM_i + "NOT FIXED: String.prototype.startsWith is natively supported" + eol;
}
if (fixed._string.endsWith) {
    msg += pM_i + "FIXED: Added endsWith method to String prototype" + eol;
}
else if ("endsWith" in String.prototype) {
    msg += pM_i + "NOT FIXED: String.prototype.endsWith is natively supported" + eol;
}
if (fixed._string.trim) {
    msg += pM_i + "FIXED: Added trim method to String prototype" + eol;
}
else if ("trim" in String.prototype) {
    msg += pM_i + "NOT FIXED: String.prototype.trim is natively supported" + eol;
}
if (fixed._string.trimLeft) {
    msg += pM_i + "FIXED: Added trimLeft method to String prototype" + eol;
}
else if ("trimLeft" in String.prototype) {
    msg += pM_i + "NOT FIXED: String.prototype.trimLeft is natively supported" + eol;
}
if (fixed._string.trimRight) {
    msg += pM_i + "FIXED: Added trimRight method to String prototype" + eol;
}
else if ("trimRight" in String.prototype) {
    msg += pM_i + "NOT FIXED: String.prototype.trimRight is natively supported" + eol;
}
if (fixed._string.repeat) {
    msg += pM_i + "FIXED: Added repeat method to String prototype" + eol;
}
else if ("repeat" in String.prototype) {
    msg += pM_i + "NOT FIXED: String.prototype.repeat is natively supported" + eol;
}
if (fixed._string.padLeft) {
    msg += pM_i + "FIXED: Added padLeft method to String prototype" + eol;
}
else if ("padLeft" in String.prototype) {
    msg += pM_i + "NOT FIXED: String.prototype.padLeft is natively supported" + eol;
}
if (fixed._string.padRight) {
    msg += pM_i + "FIXED: Added padRight method to String prototype" + eol;
}
else if ("padRight" in String.prototype) {
    msg += pM_i + "NOT FIXED: String.prototype.padRight is natively supported" + eol;
}
if (fixed._string.fromCodePoint) {
    msg += pM_i + "FIXED: Added fromCodePoint static method to String" + eol;
}
else if ("fromCodePoint" in String) {
    msg += pM_i + "NOT FIXED: String.fromCodePoint is natively supported" + eol;
}
if (fixed._string.codePointAt) {
    msg += pM_i + "FIXED: Added codePointAt method to String prototype" + eol;
}
else if ("codePointAt" in String.prototype) {
    msg += pM_i + "NOT FIXED: String.prototype.codePointAt is natively supported" + eol;
}

if (fixed._string.splitFixed) {
    msg += pM_i + "FIXED: regex bug in split where the delimiter is " + 
        "at the start or end of the string" + eol;
}

msg += eol;
var _S = UsefulJS.String;

testInput = "dwihj sdkvj kdnkd ppdc";
if (fixed._string.includes) {
    formatHdr('includes tests');

    testVal = testInput.includes("ihj sdk");
    expected = true;
    doTest('"' + testInput + '".includes("ihj sdk") === ' + expected,
        testVal, testVal === expected);

    testVal = testInput.includes("ihj sdk", 2);
    expected = true;
    doTest('"' + testInput + '".includes("ihj sdk", 2) === ' + expected,
        testVal, testVal === expected);

    testVal = testInput.includes("ihj sdk", 3);
    expected = false;
    doTest('"' + testInput + '".includes("ihj sdk", 3) === ' + expected,
        testVal, testVal === expected);

    testVal = testInput.includes("ihj sdk", "2");
    expected = true;
    doTest('"' + testInput + '".includes("ihj sdk", "2") === ' + expected,
        testVal, testVal === expected);

    testVal = testInput.includes("word");
    expected = false;
    doTest('"' + testInput + '".includes("word") === ' + expected,
        testVal, testVal === expected);

    testVal = "[object Object]".includes({});
    expected = true;
    doTest('"[object Object]".includes({}) === ' + expected,
        testVal, testVal === expected);
    msg += eol;
}
if (fixed._string.startsWith) {
    formatHdr('startsWith tests');

    testVal = testInput.startsWith("ihj sdk");
    expected = false;
    doTest('"' + testInput + '".startsWith("ihj sdk") === ' + expected,
        testVal, testVal === expected) + eol;

    testVal = testInput.startsWith("dwihj sdk");
    expected = true;
    doTest('"' + testInput + '".startsWith("dwihj sdk") === ' + expected,
        testVal, testVal === expected) + eol;

    testVal = testInput.startsWith("ihj sdk", 2);
    expected = true;
    doTest('"' + testInput + '".startsWith("ihj sdk", 2) === ' + expected,
        testVal, testVal === expected) + eol;

    testVal = testInput.startsWith("c", testInput.length - 1);
    expected = true;
    doTest('"' + testInput + '".startsWith("c", ' + (testInput.length - 1) + ') === ' + expected,
        testVal, testVal === expected) + eol;

    testVal = testInput.startsWith("ihj sdk", "2");
    expected = true;
    doTest('"' + testInput + '".startsWith("ihj sdk", "2") === ' + expected,
        testVal, testVal === expected) + eol;

    testVal = testInput.startsWith("ihj sdk", 3);
    expected = false;
    doTest('"' + testInput + '".startsWith("ihj sdk", 3) === ' + expected,
        testVal, testVal === expected) + eol;

    testVal = "[object Object]".startsWith({});
    expected = true;
    doTest('"[object Object]".startsWith({}) === ' + expected,
        testVal, testVal === expected);
    msg += eol;
}
if (fixed._string.endsWith) {
    formatHdr('endsWith tests');

    testVal = testInput.endsWith("kdnkd ppd");
    expected = false;
    doTest('"' + testInput + '".endsWith("kdnkd ppd") === ' + expected,
        testVal, testVal === expected);

    testVal = testInput.endsWith("kdnkd ppdc");
    expected = true;
    doTest('"' + testInput + '".endsWith("kdnkd ppdc") === ' + expected,
        testVal, testVal === expected);

    testVal = testInput.endsWith("kdnkd ppd", testInput.length - 1);
    expected = true;
    doTest('"' + testInput + '".endsWith("kdnkd ppd", ' + (testInput.length - 1) + ') === ' + expected,
        testVal, testVal === expected);

    testVal = testInput.endsWith("d", 1);
    expected = true;
    doTest('"' + testInput + '".endsWith("d", 1) === ' + expected,
        testVal, testVal === expected);

    testVal = testInput.endsWith("dw", "2");
    expected = true;
    doTest('"' + testInput + '".endsWith("dw", "2") === ' + expected,
        testVal, testVal === expected);

    testVal = testInput.endsWith("dw", 3);
    expected = false;
    doTest('"' + testInput + '".endsWith("dw", 3) === ' + expected,
        testVal, testVal === expected);

    testVal = "[object Object]".endsWith({});
    expected = true;
    doTest('"[object Object]".endsWith({}) === ' + expected,
        testVal, testVal === expected);
    msg += eol;
}
if (fixed._string.trim) {
    formatHdr('trim tests');

    testInput = "\t a b\t ";
    testVal = testInput.trim();
    expected = "a b";
    doTest('"\\t a b\\t ".trim() === "' + expected + '"',
        testVal, testVal === expected);

    testInput = "\u00a0\u2009a b\u00a0\u3000";
    testVal = testInput.trim();
    expected = "a b";
    doTest('"\\u00a0\\u2009a b\\u00a0\\u3000".trim() === "' + expected + '"',
        testVal, testVal === expected);

    msg += eol;
}
if (fixed._string.trimLeft) {
    formatHdr('trimLeft test');

    testInput = "\t a b\t ";
    testVal = testInput.trimLeft();
    expected = "a b\t ";
    doTest('"\\t a b\\t ".trimLeft() === "a b\\t "',
        testVal, testVal === expected);

    msg += eol;
}
if (fixed._string.trimRight) {
    formatHdr('trimRight test');

    testInput = "\t a b\t ";
    testVal = testInput.trimRight();
    expected = "\t a b";
    doTest('"\\t a b\\t ".trimRight() === "\\t a b"',
        testVal, testVal === expected);

    msg += eol;
}
if (fixed._string.repeat) {
    formatHdr('repeat tests');
    
    if (_u.featureSupport.strictMode) {
        thrown = false;
        try {
            String.prototype.repeat.call();
        }
        catch(e) {
            thrown = true;
        }
        doTest('String.prototype.repeat.call() throws', thrown, thrown === true);
    }
    
    testInput = "";
    expected = "";
    testVal = testInput.repeat();
    doTest('"".repeat() === ""', testVal, testVal === expected);
    
    testInput = "x";
    expected = "";
    testVal = testInput.repeat();
    doTest('"' + testInput + '".repeat() === ""', testVal, testVal === expected);
    
    var count = Number.NaN;
    expected = "";
    testVal = testInput.repeat(count);
    doTest('"' + testInput + '".repeat(' + count + ') === ""', testVal, testVal === expected);
    
    [-1, Number.POSITIVE_INFINITY].forEach(function(count) {
        thrown = false;
        try {
            testInput.repeat(count);
        }
        catch(e) {
            thrown = true;
        }
        doTest('"' + testInput + '".repeat(' + count + ') throws', thrown, thrown === true);
    });
    
    count = "3";
    expected = "xxx";
    testVal = testInput.repeat(count);
    doTest('"' + testInput + '".repeat("' + count + '") === "' + expected + '"', 
        testVal, testVal === expected);
    
    testInput = {};
    count = 2;
    expected = "[object Object][object Object]";
    testVal = String.prototype.repeat.call(testInput, count);
    doTest('String.prototype.repeat.call({}, ' + count + ') === "' + expected + '"', 
        testVal, testVal === expected);
    
    msg += eol;
}

if (fixed._string.fromCodePoint) {
    formatHdr('fromCodePoint tests');
    
    testInput = 0x110000;
    thrown = false;
    try {
        String.fromCodePoint(testInput);
    }
    catch(e) {
        thrown = true;
    }
    doTest('String.fromCodePoint(0x' + testInput.toString(16) + ') throws', thrown, thrown === true);
    
    testInput = 0x10300;
    p1 = 0x10301;
    p2 = 0x10302;
    expected = "𐌀𐌁𐌂";
    testVal = String.fromCodePoint(testInput, p1, p2);
    doTest('String.fromCodePoint(' + testInput + ', ' + p1 + ', ' + p2 + ') === "' +
        expected + '"', testVal, testVal === expected);
    
    msg += eol;
}

if (fixed._string.codePointAt) {
    formatHdr('codePointAt tests');
    
    testInput = "𐌀𐌁𐌂";
    testVal = testInput.codePointAt();
    expected = 0x10300;
    doTest('"' + testInput + '".codePointAt() === 0x' +
        expected.toString(16) + '', testVal, testVal === expected);
    
    testInput = "𐌀𐌁𐌂";
    p1 = testInput.length;
    testVal = testInput.codePointAt(p1);
    expected = undefined;
    doTest('"' + testInput + '".codePointAt(' + p1 + ') === ' +
        expected + '', testVal, testVal === expected);
        
    p1 = 2;
    testVal = testInput.codePointAt(p1);
    expected = 0x10301;
    doTest('"' + testInput + '".codePointAt(' + p1 + ') === 0x' +
        expected.toString(16) + '', testVal, testVal === expected);
        
    p1 = 2.5;
    testVal = testInput.codePointAt(p1);
    expected = 0x10301;
    doTest('"' + testInput + '".codePointAt(' + p1 + ') === 0x' +
        expected.toString(16) + '', testVal, testVal === expected);
        
    p1 = 3;
    testVal = testInput.codePointAt(p1);
    expected = 0xdf01;
    doTest('"' + testInput + '".codePointAt(' + p1 + ') === 0x' +
        expected.toString(16) + '', testVal, testVal === expected);
        
    msg += eol;
}

formatHdr('sprintf tests');
testBase = "UsefulJS.String";
cL = UsefulJS.Locale.current;
UsefulJS.Locale.current = "en";
testInput = null;
testVal = _S.sprintf(testInput);
expected = "";
doTest(testBase + '.sprintf(' + testInput + ') === "' +
    expected + '"', testVal, testVal === expected);

thrown = false;
testInput = "%a";
try {
    _S.sprintf(testInput);
}
catch(e) {
    thrown = true;
}
doTest(testBase + '.sprintf("' + testInput + '") throws', thrown, thrown === true);

thrown = false;
testInput = "%d";
p1 = "1";
try {
    _S.sprintf(testInput, p1);
}
catch(e) {
    thrown = true;
}
doTest(testBase + '.sprintf("' + testInput + '", "' + p1 + '") throws', thrown, thrown === true);

    
testInput = "100%%";
testVal = _S.sprintf(testInput);
expected = "100%";
doTest(testBase + '.sprintf("' + testInput + '") === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%d";
p1 = 1;
testVal = _S.sprintf(testInput, p1);
expected = "1";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%6d";
p1 = 1;
testVal = _S.sprintf(testInput, p1);
expected = "\u00A0\u00A0\u00A0\u00A0\u00A01";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%+6d";
p1 = 1;
testVal = _S.sprintf(testInput, p1);
expected = "\u00A0\u00A0\u00A0\u00A0+1";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%+06d";
p1 = 1;
testVal = _S.sprintf(testInput, p1);
expected = "+00001";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);

testInput = "%0*d";
p1 = 6;
p2 = 1;
testVal = _S.sprintf(testInput, p1, p2);
expected = "000001";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ', ' + p2 + ') === "' +
    expected + '"', testVal, testVal === expected);

testInput = "%2$0*d";
p1 = 6;
var p2 = 1;
testVal = _S.sprintf(testInput, p1, p2);
expected = "000001";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ', ' + p2 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "What do you get when you multiply %1$.1f by %2$.1f?";
p1 = 6;
p2 = 9;
testVal = _S.sprintf(testInput, p1, p2);
expected = "What do you get when you multiply 6.0 by 9.0?";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ', ' + p2 + ') === \n\t"' +
    expected + '"', testVal, testVal === expected);
    
testInput = "What do you get when you multiply %2$.1f by %1$.1f?";
expected = "What do you get when you multiply 9.0 by 6.0?";
testVal = _S.sprintf(testInput, p1, p2);
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ', ' + p2 + ') === \n\t"' +
    expected + '"', testVal, testVal === expected);

testInput = "What do you get when you multiply %3$.*f by %4$.*f?";
expected = "What do you get when you multiply 6.0 by 9.0?";
testVal = _S.sprintf(testInput, 1, 1, p1, p2);
doTest(testBase + '.sprintf("' + testInput + '", 1, 1, ' + p1 + ', ' + p2 + ') === \n\t"' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%,d";
p1 = 1000;
testVal = _S.sprintf(testInput, p1);
expected = "1,000";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "% d";
p1 = 1000;
testVal = _S.sprintf(testInput, p1);
expected = "\u00A01000";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);

testInput = "%,i";
p1 = 1000;
testVal = _S.sprintf(testInput, p1);
expected = "1000";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%1$d/%1$d vision";
p1 = 20;
testVal = _S.sprintf(testInput, p1);
expected = "20/20 vision";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);

testInput = "%6d";
p1 = -123.45;
testVal = _S.sprintf(testInput, p1);
expected = "\u00A0\u00A0-123";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%+u";
p1 = -1;
testVal = _S.sprintf(testInput, p1);
expected = "4294967295";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%04o";
p1 = 438;
testVal = _S.sprintf(testInput, p1);
expected = "0666";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);

testInput = "%#5o";    
testVal = _S.sprintf(testInput, p1);
expected = "\u00A00666";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%x";
p1 = 3735928559;
testVal = _S.sprintf(testInput, p1);
expected = "deadbeef";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%#x";
p1 = 3735928559;
testVal = _S.sprintf(testInput, p1);
expected = "0xdeadbeef";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%0#12X";
p1 = 3735928559;
testVal = _S.sprintf(testInput, p1);
expected = "0X00DEADBEEF";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%b";
p1 = 21;
testVal = _S.sprintf(testInput, p1);
expected = "10101";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%#8b";
p1 = 21;
testVal = _S.sprintf(testInput, p1);
expected = "\u00A00b10101";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%#B";
p1 = 21;
testVal = _S.sprintf(testInput, p1);
expected = "0B10101";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%8s";
p1 = "expand";
testVal = _S.sprintf(testInput, p1);
expected = "\xa0\xa0expand";
doTest(testBase + '.sprintf("' + testInput + '", "' + p1 + '") === "' +
    expected + '"', testVal, testVal === expected);

testInput = "%-8s";
p1 = "expand";
testVal = _S.sprintf(testInput, p1);
expected = "expand\xa0\xa0";
doTest(testBase + '.sprintf("' + testInput + '", "' + p1 + '") === "' +
    expected + '"', testVal, testVal === expected);

testInput = "%.8s";
p1 = "truncated";
testVal = _S.sprintf(testInput, p1);
expected = "truncate";
doTest(testBase + '.sprintf("' + testInput + '", "' + p1 + '") === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%8.4s";
p1 = "expand";
testVal = _S.sprintf(testInput, p1);
expected = "\xa0\xa0\xa0\xa0expa";
doTest(testBase + '.sprintf("' + testInput + '", "' + p1 + '") === "' +
    expected + '"', testVal, testVal === expected);

testInput = "%f";
p1 = 1;
testVal = _S.sprintf(testInput, p1);
expected = "1.000000";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%.3f";
p1 = -1.0015;
testVal = _S.sprintf(testInput, p1);
expected = "-1.002";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%.*f";
p1 = 3;
p2 = -1.0015;
testVal = _S.sprintf(testInput, p1, p2);
expected = "-1.002";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ', ' + p2 + ') === "' +
    expected + '"', testVal, testVal === expected);

testInput = "%.*f";
p1 = -3;
p2 = -1.0015;
testVal = _S.sprintf(testInput, p1, p2);
expected = "-1.001500";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ', ' + p2 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%e";
p1 = 0.00000000000123;
testVal = _S.sprintf(testInput, p1);
expected = "1.230000e-12";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
p1 = 1;
testVal = _S.sprintf(testInput, p1);
expected = "1.000000e+00";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%.2E";
p1 = 100.1;
testVal = _S.sprintf(testInput, p1);
expected = "1.00E+02";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%c%c";
p1 = 0x10300;
p2 = 0x10301;
testVal = _S.sprintf(testInput, p1, p2);
expected = "𐌀𐌁";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ', ' + p2 + ') === "' +
    expected + '"', testVal, testVal === expected);

UsefulJS.Locale.current = "ar";
testInput = "%06d";
p1 = -1001.4;
testVal = _S.sprintf(testInput, p1);
expected = "٠١٠٠١-";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%6d";
p1 = -1001.5;
testVal = _S.sprintf(testInput, p1);
expected = "\u00A0١٠٠٢-";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
testInput = "%+6d";
p1 = 1001;
testVal = _S.sprintf(testInput, p1);
expected = "\u00A0١٠٠١+";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
UsefulJS.Locale.current = "sv";
testInput = "%06d";
p1 = -1001;
testVal = _S.sprintf(testInput, p1);
expected = "\u221201001";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);
    
UsefulJS.Locale.current = "fr";
testInput = "%0,10.3f";
p1 = 1001.2356;
testVal = _S.sprintf(testInput, p1);
expected = "01\u00a0001,236";
doTest(testBase + '.sprintf("' + testInput + '", ' + p1 + ') === "' +
    expected + '"', testVal, testVal === expected);

UsefulJS.Locale.current = cL;    
msg += eol;

/*formatHdr('String formatting test');
testInput = "A %1 B %3 C %2 D %4 E %4 F %5 G %6 H %9 I %10%";
fmtStr = '"Z", "Y", "X", "W", "V", "U", "T", "S", "R", 100';
testVal = _S.format(testInput, "Z", "Y", "X", "W", "V", "U", "T", "S", "R", 100);
expected = "A Z B X C Y D W E W F V G U H R I 100%";
doTest(testBase + '.format("' + testInput + '",' + eol + '\t' + fmtStr + ') === "' +
    expected + '"', testVal, testVal === expected);

msg += eol;*/

/*formatHdr('strlen tests');

testVal = _S.strlen();
expected = 0;
doTest(testBase + '.strlen() === ' + expected, 
    testVal, testVal === expected);
    
testInput = 0;
testVal = _S.strlen(testInput);
expected = 1;
doTest(testBase + '.strlen(' + testInput + ') === ' + expected, 
    testVal, testVal === expected);
    
testInput = "𐌀𐌁𐌂";
testVal = _S.strlen(testInput);
expected = 3;
doTest(testBase + '.strlen("' + testInput + '") === ' + expected, 
    testVal, testVal === expected);
    
testInput = "Ṣé\u0323é\u0323ré\u0323";
testVal = _S.strlen(testInput);
expected = 5;
doTest(testBase + '.strlen("' + testInput + '") === ' + expected, 
    testVal, testVal === expected);

msg += eol;*/

testBase = "UsefulJS.String.escape";
formatHdr('String escaping tests');
var eFn = _S.escape.html;
testInput = "<i>A&B\u003c/i>";
testVal = eFn(testInput);
expected = "&lt;i&gt;A&amp;B&lt;&#x2f;i&gt;";
doTest(testBase + '.html("' + eFn(testInput) + '") === "' + eFn(expected) + '"',
    eFn(testVal), testVal === expected);

eFn = _S.escape.js;
var cpE = _u.featureSupport.string.codePointEscaping;
testInput = "\x3c\x2fscript\x3e";
testVal = eFn(testInput);
expected = "\\x3c\\x2fscript\\x3e";
doTest(testBase + '.js("' + _S.escape.html(testInput) + '") === "' + expected + '"',
    testVal, testVal === expected);
    
testInput = "ΑΒΓ";
testVal = eFn(testInput);
expected = cpE ? "\\u{391}\\u{392}\\u{393}" : "\\u0391\\u0392\\u0393";
doTest(testBase + '.js("' + testInput + '") === "' + expected + '"',
    testVal, testVal === expected);
   
if (cpE) {
    testInput = "𐌀𐌁𐌂";
    testVal = eFn(testInput);
    expected = "\\u{10300}\\u{10301}\\u{10302}";
    doTest(testBase + '.js("' + testInput + '") === "' + expected + '"',
        testVal, testVal === expected);
}

eFn = _S.escape.regex;
testInput = "\\.-[]{}()^$|+?*";
testVal = new RegExp(eFn(testInput)).test(testInput);
expected = true;
doTest('new RegExp(' + testBase + '.regex("' + testInput + '")).test("' +
    testInput + '") === true', testVal, testVal === expected);
msg += eol;

testBase = "UsefulJS.String.encode";
formatHdr('String encoding tests');
eFn = _S.encode.toUtf8;
testInput = "𐌀€£$";
testVal = eFn(testInput);
expected = "\xf0\x90\x8C\x80\xe2\x82\xac\xc2\xa3$";
doTest(testBase + '.toUtf8("' + testInput + '") === "' + _S.escape.js(expected) + '"',
    _S.escape.js(testVal), testVal === expected);
    
testInput = "\ud800";
testVal = eFn(testInput);
expected = "\xef\xbf\xbd";
doTest(testBase + '.toUtf8("' + _S.escape.js(testInput) + '") === "' + _S.escape.js(expected) + '"',
    _S.escape.js(testVal), testVal === expected);

eFn = _S.encode.fromUtf8;
testInput = "\u00e2\u0088\u009e";
testVal = eFn(testInput);
expected = "∞";
doTest(testBase + '.fromUtf8("\\u00e2\\u0088\\u009e") === "' + expected + '"',
    testVal, testVal === expected);
    
testInput = "\xe2\x9e\xc2\xa3";
testVal = eFn(testInput);
expected = "\ufffd\£";
doTest(testBase + '.fromUtf8("\\xe2\\x9e\\xc2\\xa3") === "' + expected + '"',
    testVal, testVal === expected);

testInput = "\x88\x9e\xc2\xa3";
testVal = eFn(testInput);
expected = "\ufffd\£";
doTest(testBase + '.fromUtf8("\\x88\\x9e\\xc2\\xa3") === "' + expected + '"',
    testVal, testVal === expected);
    
testInput = "\xf4\x90\x80\x80";
testVal = eFn(testInput);
expected = "\ufffd";
doTest(testBase + '.fromUtf8("\\xf4\\x90\\x80\\x80") === "' + expected + '"',
    testVal, testVal === expected);
    
testInput = "\xf4\x8f\xbf\xbf";
testVal = eFn(testInput);
expected = "\udbff\udfff";
doTest(testBase + '.fromUtf8("\\xf4\\x8f\\xbf\\xbf") === "' + expected + '"',
    testVal, testVal === expected);
    
testInput = "\xef\xbf\xbe";
testVal = eFn(testInput);
expected = "\ufffe";
doTest(testBase + '.fromUtf8("\\xef\\xbf\\xbe") === "' + expected + '"',
    testVal, testVal === expected);
    
testInput = "\xf0\x90\x8C\x80";
testVal = eFn(testInput);
expected = "\ud800\udf00";
doTest(testBase + '.fromUtf8("\\xf0\\x90\\x8C\\x80") === "' + expected + '"',
    testVal, testVal === expected);
    
testInput = "\xed\xad\xbf\xed\xb0\x80";
testVal = eFn(testInput);
expected = "\ufffd\ufffd";
doTest(testBase + '.fromUtf8("\\xed\\xad\\xbf\\xed\\xb0\\x80") === "' + expected + '"',
    testVal, testVal === expected);

expected = "\ufffd";   
var overlong = {
    "\\xc0\\xaf" : "\xc0\xaf",
    "\\xe0\\x80\\xaf" : "\xe0\x80\xaf",
    "\\xc1\\xbf" : "\xc1\xbf",
    "\\xf0\\x8f\\xbf\\xbf" : "\xf0\x8f\xbf\xbf",
    "\\xf8\\x80\\x80\\x80\\x80" : "\xf8\x80\x80\x80\x80"
}, failed = 0;

for (p1 in overlong) {
    testInput = overlong[p1];
    testVal = eFn(testInput);
    if (testVal !== expected) {
        doTest(testBase + '.fromUtf8("' + p1 + '") === "' + expected + '"',
            testVal, testVal === expected);
        ++failed;
    }
}
doTest("All overlong sequences handled", failed, failed === 0);

eFn = _S.encode.crlf;
testInput = "a\nb\r\nc\n";
testVal = eFn(testInput);
expected = "a\r\nb\r\nc\r\n";
doTest(testBase + '.crlf("' + _S.escape.js(testInput) + '") === "' +
    _S.escape.js(expected) + '"', testVal, testVal === expected);

eFn = _S.encode.lf;
testInput = "a\nb\r\nc\n";
testVal = eFn(testInput);
expected = "a\nb\nc\n";
doTest(testBase + '.lf("' + _S.escape.js(testInput) + '") === "' +
    _S.escape.js(expected) + '"', testVal, testVal === expected);

if (fixed._string.splitFixed) {
    formatHdr('String.prototype.split fix test');
    testInput = "-A-B-";
    testVal = testInput.split(/-/).length;
    expected = 4;
    doTest('"' + testInput + '"split(/-/).length === ' + expected,
        testVal, testVal === expected);

    msg += eol;
}

msg += eol;

formatHdr('UsefulJS.Date');

var _D = _u.Date, _DTF = _D.Format, testObj = new _DTF("en");
if (_u.featureSupport.date.timezone) {
    msg += pM_i + "Timezone name can be obtained from the system and is currently " + 
        _u.featureSupport.date.tzCode + eol;
}
if (fixed._date.now) {
    msg += pM_i + 'FIXED: Added now static method to Date; the current time in epoch seconds is ' +
        Math.floor(Date.now() / 1000) + eol;
}
else if ("now" in Date) {
    msg += pM_i + 'NOT FIXED: Date.now is natively supported' + eol;
}
if (fixed._date.toISOString) {
    msg += pM_i + 'FIXED: Added toISOString method to Date.prototype' + eol;
}
else if ("toISOString" in Date.prototype) {
    msg += pM_i + 'NOT FIXED: Date.prototype.toISOString is natively supported' + eol;
}
if (fixed._date.toRFC822String) {
    msg += pM_i + 'FIXED: Added toRFC822String method to Date.prototype' + eol;
}
else if ("toRFC822String" in Date.prototype) {
    msg += pM_i + 'NOT FIXED: Date.prototype.toRFC822String is natively supported' + eol;
}
if (fixed._date.intl_DateTimeFormat) {
    msg += pM_i + 'FIXED: Added Intl.DateTimeFormat to the global context' + eol;
}
else if ("Intl" in window && "DateTimeFormat" in window.Intl) {
    msg += pM_i + 'NOT FIXED: Intl.DateTimeFormat is natively supported' + eol;
}

msg += eol;

formatHdr('Leap year tests');

var calendarObj = UsefulJS.Locale.dateOptions("en").calendarObj;
testBase = "UsefulJS.Date.isLeapYear";
testVal = calendarObj.isLeapYear("NaN");
doTest('"NaN" === false', testVal, testVal === false);

testVal = calendarObj.isLeapYear(Number.POSITIVE_INFINITY);
doTest('Number.POSITIVE_INFINITY === false', testVal, testVal === false);

testVal = calendarObj.isLeapYear(2012);
doTest('2012 === true', testVal, testVal === true);

testVal = calendarObj.isLeapYear(-2012);
doTest('-2012 === true', testVal, testVal === true);

testVal = calendarObj.isLeapYear("4");
doTest('"4" === true', testVal, testVal === true);

testVal = calendarObj.isLeapYear(13);
doTest('13 === false', testVal, testVal === false);

testVal = calendarObj.isLeapYear(1900);
doTest('1900 === false', testVal, testVal === false);

msg += eol;

formatHdr('UsefulJS.Date.Format');
testBase = "format";

thrown = false;
try {
    testObj.format("date", "%Y");
}
catch(e) {
    thrown = true;
}
doTest(testBase + '("date", "%Y") throws', thrown, thrown === true);

thrown = false;
try {
    testObj.format(new Date(), "%1");
}
catch(e) {
    thrown = true;
}
doTest(testBase + '(new Date(), "%1") throws', thrown, thrown === true);

cL = _u.Locale.current;
// Sun Sep 29 2013 14:09:54 GMT+0100
var dt = new Date(2013, 8, 29, 13, 9, 54);
var tzOffs = dt.getTimezoneOffset(), _tzOffs = Math.abs(tzOffs),
    mz = _tzOffs % 60;
_tzOffs -= mz;
var hz = _tzOffs / 60, sign = (tzOffs <= 0) ? "+" : "-";
var szOffs = sign + String(hz).padLeft(2, '0') + String(mz).padLeft(2, '0');
var fmtStr, dateStr;
testInput = 'new Date(2013, 8, 29, 13, 9, 54)';
var hE = 13, mE = 54, tRe = /(\d{1,2}):(\d{1,2})/, tMatch = tRe.exec(dt.toString());
if (tMatch) {
    hE = Number(tMatch[1]);
    mE = Number(tMatch[2]);
}
var h12E = hE % 12;
if (0 === h12E) {
    h12E = 12;
}


if (fixed._date.toISOString) {
    testVal = dt.toISOString();
    expected = "2013-09-" + String(dt.getUTCDate()).padLeft(2, '0') +
        'T' + String(dt.getUTCHours()).padLeft(2, '0') + ':' +
        String(dt.getUTCMinutes()).padLeft(2, '0') + ':' +
        String(dt.getUTCSeconds()).padLeft(2, '0') + '.' +
        String(dt.getUTCMilliseconds()).padLeft(3, '0') + 'Z';
    doTest('(' + testInput + ').toISOString() === "' + expected + '"',
        testVal, testVal === expected);
}
if (fixed._date.toRFC822String) {
    testVal = dt.toRFC822String();
    expected = 'Sun, 29 Sep 2013 ' + String(dt.getHours()).padLeft(2, '0') + 
        ':' + String(dt.getMinutes()).padLeft(2, '0') + ':54 ' + szOffs;
    doTest('(' + testInput + ').toRFC822String() === "' + expected + '"',
        testVal, testVal === expected);
}

_u.Locale.current = "en";
// Test individual codes
fmtStr = "%a";
testVal = testObj.format(dt, fmtStr);
expected = "Sun";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

testObj = new _DTF("es");
testVal = testObj.format(dt, fmtStr);
expected = "dom";
doTest('es, short day: ' + testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%A";
testObj = new _DTF("de");
testVal = testObj.format(dt, fmtStr);
expected = "Sonntag";
doTest('de, long day: ' + testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%b";
testObj = new _DTF("zh");
testVal = testObj.format(dt, fmtStr);
expected = "9月";
doTest('zh, short month: ' + testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);
fmtStr = "%h";
testVal = testObj.format(dt, fmtStr, "zh");
doTest('zh, short month: ' + testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%B";
testObj = new _DTF("fr");
testVal = testObj.format(dt, fmtStr);
expected = "septembre";
doTest('fr, long month: ' + testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%C";
testVal = testObj.format(dt, fmtStr);
expected = "20";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%d";
testVal = testObj.format(dt, fmtStr);
expected = "29";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%D";
testVal = testObj.format(dt, fmtStr);
expected = "09/29/13";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);
fmtStr = "%ED";
testVal = testObj.format(dt, fmtStr);
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%H";
testVal = testObj.format(dt, fmtStr);
expected = hE.toString().padLeft(2, '0');
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

testVal = testObj.format(dt, "%I");
expected = h12E.toString().padLeft(2, '0');
doTest(testBase + '(' + testInput + ', "%I") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%n";
testVal = testObj.format(dt, fmtStr);
expected = "\n";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + _S.escape.js(expected) + '"',
    testVal, testVal === expected);

fmtStr = "%N";
testVal = testObj.format(dt, fmtStr);
expected = "9";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%p";
testObj = new _DTF("en");
testVal = testObj.format(dt, fmtStr);
expected = (hE >= 12) ? "PM" : "AM";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%P";
testVal = testObj.format(dt, fmtStr);
expected = (hE >= 12) ? "pm" : "am";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

testObj = new _DTF("zh");
testVal = testObj.format(dt, "%r");
expected = "下午" + h12E.toString().padLeft(2, '0') + "时" + mE.toString().padLeft(2, '0') + "分54秒";
doTest('zh, 12-hour time: ' + testBase + '(' + testInput + ', "%r") === ' + expected,
    testVal, testVal === expected);

testObj = new _DTF("fr");
testVal = testObj.format(dt, "%r");
expected = hE.toString().padLeft(2, '0') + ":" + mE.toString().padLeft(2, '0') + ':54';
doTest('fr, 24-hour time: ' + testBase + '(' + testInput + ', "%r") === ' + expected,
    testVal, testVal === expected);

fmtStr = "%R";
testVal = testObj.format(dt, fmtStr);
expected = hE.toString().padLeft(2, '0') + ":" + mE.toString().padLeft(2, '0');
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

var eSecs = Math.floor(dt.getTime() / 1000);
fmtStr = "%s";
testVal = testObj.format(dt, fmtStr);
expected = String(eSecs);
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%t";
testVal = testObj.format(dt, fmtStr);
expected = "\t";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + _S.escape.js(expected) + '"',
    testVal, testVal === expected);

fmtStr = "%T";
testVal = testObj.format(dt, fmtStr);
expected = hE.toString().padLeft(2, '0') + ":" + mE.toString().padLeft(2, '0') + ':54';
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%u";
testVal = testObj.format(dt, fmtStr);
expected = "7";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%w";
testVal = testObj.format(dt, fmtStr);
expected = "0";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%%";
testVal = testObj.format(dt, fmtStr);
expected = "%";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

var dtTz = new Date();
fmtStr = "%z";
testVal = testObj.format(dt, fmtStr);
expected = szOffs;
doTest(testBase + '(new Date(), "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt.setDate(9);
testVal = testObj.format(dt, "%e");
expected = "9";
testInput = testInput.replace(" 29,", " 9,");
doTest(testBase + '(' + testInput + ', "%e") === "' + expected + '"',
    testVal, testVal === expected);

dt.setHours(0);
testInput = testInput.replace(" 13,", " 0,");
tMatch = tRe.exec(dt.toString());
if (tMatch) {
    hE = Number(tMatch[1]);
    mE = Number(tMatch[2]);
}
h12E = hE % 12;
if (0 === h12E) {
    h12E = 12;
}
fmtStr = "%l";
testVal = testObj.format(dt, fmtStr);
expected = h12E.toString();
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%S.%/";
testInput = 'new Date(1)';
dt = new Date(1);
testVal = testObj.format(dt, fmtStr);
expected = "00.001";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt = new Date(2013, 10, 1, 0, 0, 0);
testObj = new _DTF("cy");
fmtStr = "%l %p";
testInput = 'new Date(2013, 10, 1, 0, 0, 0)';
testVal = testObj.format(dt, fmtStr, "cy");
expected = "12 y.b.";
doTest('cy, morning: ' + testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt.setHours(12);
testInput = testInput.replace("1, 0,", "1, 12,");
testVal = testObj.format(dt, fmtStr, "cy");
expected = "12 y.p.";
doTest('cy, afternoon: ' + testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt.setHours(18);
testInput = testInput.replace("12,", "18,");
testVal = testObj.format(dt, fmtStr, "cy");
expected = "6 y.h.";
doTest('cy, evening: ' + testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt = new Date(-1, 0, 1, 12, 0, 0);
testObj = new _DTF("en-u-ca-iso8601");
fmtStr = "%Y";
testInput = 'new Date(-1, 0, 1, 12, 0, 0, 0)';
expected = "-0001";
testVal = testObj.format(dt, fmtStr);
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%y";
expected = "01";
testVal = testObj.format(dt, fmtStr);
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%C";
expected = "-00";
testVal = testObj.format(dt, fmtStr);
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt.setFullYear(0);
fmtStr = "%F";
expected = "+0000-01-01";
testInput = 'new Date(0000, 0, 1, 12, 0, 0, 0)';
testVal = testObj.format(dt, fmtStr);
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

// Alternative nominative / genitive forms
dt = new Date(2013, 11, 1, 12, 0, 0, 0);
testInput = 'new Date(2013, 11, 1, 12, 0, 0, 0)';
testObj = new _DTF("el", { year : "numeric", month : "long" });
expected = "Δεκέμβριος 2013";
testVal = testObj.format(dt);
doTest('el, nominative: ' + testBase + '(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);

fmtStr = "%e %B %Y";
testObj = new _DTF("el", { year : "numeric", month : "long", day : "numeric" });
expected = "1 Δεκεμβρίου 2013";
testVal = testObj.format(dt);
doTest('el, genitive: ' + testBase + '(' + testInput + ') === "' + expected + '"',
    testVal, testVal === expected);


// Year day number
testObj = new _DTF("en-u-ca-iso8601");
dt = new Date(2011, 0, 1, 12, 0, 0, 0);
testInput = 'new Date(2011, 0, 1, 12, 0, 0, 0)';
fmtStr = "%j";
expected = "001";
testVal = testObj.format(dt, fmtStr);
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt = new Date(2011, 11, 31, 12, 0, 0, 0);
testInput = 'new Date(2011, 11, 31, 12, 0, 0, 0)';
expected = "365";
testVal = testObj.format(dt, fmtStr);
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt = new Date(2012, 11, 31, 12, 0, 0, 0);
testInput = 'new Date(2012, 11, 31, 12, 0, 0, 0)';
expected = "366";
testVal = testObj.format(dt, fmtStr);
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

// Week number test
fmtStr = "%W";
testVal = testObj.format(dt, fmtStr);
expected = "53";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);


dt = new Date(2013, 0, 1, 12, 0, 0, 0);
testInput = 'new Date(2013, 0, 1, 12, 0, 0, 0)';
testVal = testObj.format(dt, fmtStr);
expected = "00";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt.setDate(6);
testInput = testInput.replace("1,", "6,");
testVal = testObj.format(dt, fmtStr);
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt.setDate(7);
testInput = testInput.replace("6,", "7,");
testVal = testObj.format(dt, fmtStr);
expected = "01";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt.setMonth(9);
testInput = testInput.replace("3, 0", "3, 9");
testVal = testObj.format(dt, fmtStr);
expected = "40";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt.setDate(6);
testInput = testInput.replace("7,", "6,");
testVal = testObj.format(dt, fmtStr);
expected = "39";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt.setMonth(11);
dt.setDate(31);
testInput = testInput.replace("3, 9", "3, 11").replace("6,", "31,");
testVal = testObj.format(dt, fmtStr);
expected = "52";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt = new Date(2012, 11, 30, 12, 0, 0, 0);
testInput = 'new Date(2012, 11, 30, 12, 0, 0, 0)';
fmtStr = "%U";
testVal = testObj.format(dt, fmtStr);
expected = "53";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt.setDate(29);
testInput = testInput.replace("30,", "29,");
testVal = testObj.format(dt, fmtStr);
expected = "52";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt = new Date(2013, 0, 5, 12, 0, 0, 0);
testInput = 'new Date(2013, 0, 5, 12, 0, 0, 0)';
testVal = testObj.format(dt, fmtStr);
expected = "00";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

dt.setDate(6);
testInput = testInput.replace("5,", "6,");
testVal = testObj.format(dt, fmtStr);
expected = "01";
doTest(testBase + '(' + testInput + ', "' + fmtStr + '") === "' + expected + '"',
    testVal, testVal === expected);

// ISO 8601 week test
fmtStr = "%Y %U %W %V %G %g";
dt = new Date(2009, 11, 31, 12, 0, 0, 0); // Thu, 31st Jan
testVal = testObj.format(dt, fmtStr);
expected = "2009 52 52 53 2009 09";
doTest(testBase + '(new Date(2009, 11, 31, 12, 0, 0, 0), "' + fmtStr + '") === "' + expected + '"',
    testVal, (testVal === expected));

dt = new Date(2010, 0, 1, 12, 0, 0, 0); // Fri, 1st Jan
testVal = testObj.format(dt, fmtStr);
expected = "2010 00 00 53 2009 09";
doTest(testBase + '(new Date(2010, 0, 1, 12, 0, 0, 0), "' + fmtStr + '") === "' + expected + '"',
    testVal, (testVal === expected));

dt.setDate(3); // Sun, 3rd Jan
testVal = testObj.format(dt, fmtStr);
expected = "2010 01 00 53 2009 09";
doTest(testBase + '(new Date(2010, 0, 3, 12, 0, 0, 0), "' + fmtStr + '") === "' + expected + '"',
    testVal, (testVal === expected));

dt.setDate(4); // Mon, 4th Jan
testVal = testObj.format(dt, fmtStr);
expected = "2010 01 01 01 2010 10";
doTest(testBase + '(new Date(2010, 0, 4, 12, 0, 0, 0), "' + fmtStr + '") === "' + expected + '"',
    testVal, (testVal === expected));

dt = new Date(-1, 0, 1, 12, 0, 0, 0);
testVal = testObj.format(dt, fmtStr);
expected = "-0001 00 00 53 -0002 02";
doTest(testBase + '(new Date(-1, 0, 1, 12, 0, 0, 0), "' + fmtStr + '") === "' + expected + '"',
    testVal, (testVal === expected));

// Alt calendars
dt = new Date(2013, 5, 5);
testObj = new _DTF("en-u-ca-buddhist", { year : "numeric", era : "short" });
testVal = testObj.format(dt);
expected = "2556 BE";
doTest('ca: buddhist; ' + testBase + '(new Date(2013, 5, 5)) === "' + expected + '"',
    testVal, (testVal === expected));
dt.setFullYear(-543);
testVal = testObj.format(dt);
expected = "0 BE";
doTest('ca: buddhist; ' + testBase + '(new Date(-543, 5, 5)) === "' + expected + '"',
    testVal, (testVal === expected));

msg += eol;

formatHdr('Date format string tests');

_u.Locale.current = "en";
testBase = 'UsefulJS.Date.getFormatString';

thrown = false;
testInput = { weekday : "loong" };
var dateOpts = _u.Locale.dateOptions("en", testInput), resolved = {};
try {
    _D.getFormatString(dateOpts, resolved);
}
catch(e) {
    thrown = true;
}
doTest('Out of range value throws', thrown, thrown === true);

testVal = [];
expected = ["%A", "%a", "%a"];
["long", "short", "narrow"].forEach(function(opt) {
    testInput = { weekday : opt };
    dateOpts = _u.Locale.dateOptions("en", testInput), resolved = {};
    testVal.push(_D.getFormatString(dateOpts, resolved));
});
doTest('Weekday options resolve', testVal,
    testVal.toString() === expected.toString());

testVal = [];
expected = ["%Y", "%y"];
["numeric", "2-digit"].forEach(function(opt) {
    testInput = { year : opt };
    dateOpts = _u.Locale.dateOptions("en", testInput), resolved = {};
    testVal.push(_D.getFormatString(dateOpts, resolved));
});
doTest('Year options resolve', testVal,
    testVal.toString() === expected.toString());

testVal = [];
expected = ["%B", "%b", "%b", "%N", "%m"];
["long", "short", "narrow", "numeric", "2-digit"].forEach(function(opt) {
    testInput = { month : opt };
    dateOpts = _u.Locale.dateOptions("en", testInput), resolved = {};
    testVal.push(_D.getFormatString(dateOpts, resolved));
});
doTest('Month options resolve', testVal,
    testVal.toString() === expected.toString());

testVal = [];
expected = ["%e", "%d"];
["numeric", "2-digit"].forEach(function(opt) {
    testInput = { day : opt };
    dateOpts = _u.Locale.dateOptions("en", testInput), resolved = {};
    testVal.push(_D.getFormatString(dateOpts, resolved));
});
doTest('Day options resolve', testVal,
    testVal.toString() === expected.toString());

testVal = [];
expected = ["%k", "%H"];
["numeric", "2-digit"].forEach(function(opt) {
    testInput = { hour : opt, hour12 : false };
    dateOpts = _u.Locale.dateOptions("en", testInput), resolved = {};
    testVal.push(_D.getFormatString(dateOpts, resolved));
});
doTest('Hour options resolve', testVal,
    testVal.toString() === expected.toString());

testVal = [];
expected = ["%l %p", "%I %p"];
["numeric", "2-digit"].forEach(function(opt) {
    testInput = { hour : opt, hour12 : true };
    dateOpts = _u.Locale.dateOptions("en", testInput), resolved = {};
    testVal.push(_D.getFormatString(dateOpts, resolved));
});
doTest('12-hour options resolve', testVal,
    testVal.toString() === expected.toString());

testVal = [];
expected = ["%M", "%M"];
["numeric", "2-digit"].forEach(function(opt) {
    testInput = { minute : opt, hour12 : false };
    dateOpts = _u.Locale.dateOptions("en", testInput), resolved = {};
    testVal.push(_D.getFormatString(dateOpts, resolved));
});
doTest('Minute options resolve', testVal,
    testVal.toString() === expected.toString());

testVal = [];
expected = ["%S", "%S"];
["numeric", "2-digit"].forEach(function(opt) {
    testInput = { second : opt, hour12 : false };
    dateOpts = _u.Locale.dateOptions("en", testInput), resolved = {};
    testVal.push(_D.getFormatString(dateOpts, resolved));
});
doTest('Second options resolve', testVal,
    testVal.toString() === expected.toString());

dateOpts = _u.Locale.dateOptions("en"), resolved = {};
testVal = _D.getFormatString(dateOpts, resolved);
expected = "%N/%e/%Y";
doTest('No options produce a numeric date string', testVal, testVal === expected);

testInput = { hour : "2-digit", minute : "numeric", timeZoneName : "long" };
dateOpts = _u.Locale.dateOptions("en", testInput), resolved = {};
testVal = _D.getFormatString(dateOpts, resolved);
expected = "%I:%M %p GMT%z";
doTest('TimeZoneName option resolved', testVal, testVal === expected);

testInput = { era : "long" };
dateOpts = _u.Locale.dateOptions("en", testInput), resolved = {};
testVal = _D.getFormatString(dateOpts, resolved);
expected = "%N/%e/%Y %!";
doTest('Era option resolved', testVal, testVal === expected);
msg += eol;

formatHdr('Date parsing tests');

testBase = "parse";
testObj = new _DTF();
thrown = false;

thrown = false;
try {
    testObj.parse(null, "%Y");
}
catch(e) {
    thrown = true;
}
doTest(testBase + '(null, "%Y") throws', thrown, (thrown === true));

thrown = false;
try {
    testObj.parse("Stuff", "%+");
}
catch(e) {
    thrown = true;
}
doTest(testBase + '("Stuff", "%+") throws', thrown, (thrown === true));

// Unmatchable month name
thrown = false;
try {
    testObj.parse("Wed Octber 02 2013", "%a %B %d %Y");
}
catch(e) {
    thrown = true;
}
doTest(testBase + '("Wed Octber 02 2013", "%a %B %d %Y") throws', thrown, (thrown === true));

// Unmatched code in the format string
thrown = false;
try {
    testObj.parse("Wed October 02 2013 12pm", "%a %B %d %Y %I%P %z");
}
catch(e) {
    thrown = true;
}
doTest(testBase + '("Wed October 02 2013 12pm", "%a %B %d %Y %I%P %z") throws',
    thrown, (thrown === true));

// Out-of-range values
// 0 - 6
thrown = false;
try {
    testObj.parse("7", "%w");
}
catch(e) {
    thrown = true;
}
doTest(testBase + '("7", "%w") throws',
    thrown, (thrown === true));

// This one is good
thrown = false;
try {
    testObj.parse("7", "%u");
}
catch(e) {
    thrown = true;
}
doTest(testBase + '("7", "%u") does not throw',
    thrown, (thrown === false));

// 0 - 999
thrown = false;
try {
    testObj.parse("1000", "%/");
}
catch(e) {
    thrown = true;
}
doTest(testBase + '("1000", "%/") throws',
    thrown, (thrown === true));

// Never more than 366 days
thrown = false;
try {
    testObj.parse("367", "%j");
}
catch(e) {
    thrown = true;
}
doTest(testBase + '("367", "%j") throws',
    thrown, (thrown === true));

// Date value testing functions
var testDateValue = function(dP, y, m, d, h, min, s, ms) {
    if (!(null == y || y === dP.getFullYear())) {
        return false;
    }
    if (!(null == m || m === dP.getMonth())) {
        return false;
    }
    if (!(null == d || d === dP.getDate())) {
        return false;
    }
    if (!(null == h || h === dP.getHours())) {
        return false;
    }
    if (!(null == min || min === dP.getMinutes())) {
        return false;
    }
    if (!(null == s || s === dP.getSeconds())) {
        return false;
    }
    if (!(null == ms || ms === dP.getMilliseconds())) {
        return false;
    }
    return true;
};

var testDateValue_u = function(dP, y, m, d, h, min, s, ms) {
    if (!(null == y || y === dP.getUTCFullYear())) {
        return false;
    }
    if (!(null == m || m === dP.getUTCMonth())) {
        return false;
    }
    if (!(null == d || d === dP.getUTCDate())) {
        return false;
    }
    if (!(null == h || h === dP.getUTCHours())) {
        return false;
    }
    if (!(null == min || min === dP.getUTCMinutes())) {
        return false;
    }
    if (!(null == s || s === dP.getUTCSeconds())) {
        return false;
    }
    if (!(null == ms || ms === dP.getUTCMilliseconds())) {
        return false;
    }
    return true;
};

fmtStr = "%a %B %d %Y %I%P";
var dP = testObj.parse("Wed October 02 2013 12pm", fmtStr);
doTest(testBase + '("Wed October 02 2013 12pm", "' + fmtStr + '")' +
    ' -> 9, 2, 2013, 12, 0, 0', dP, testDateValue(dP, 2013, 9, 2, 12, 0, 0));

fmtStr = "%a %B %d %Y %I%P %z (%Z)";
dP = testObj.parse("Wed October 02 2013 12pm -0230 (WTF)", fmtStr);
doTest(testBase + '("Wed October 02 2013 12pm -0230 (WTF)", ' + 
    '"' + fmtStr + '") -> (UTC) 9, 2, 2013, 14, 30, 0',
    dP, testDateValue_u(dP, 2013, 9, 2, 14, 30, 0));

fmtStr = "%a %B %d %Y %I%P %z (%Z)";
dP = testObj.parse("Wed October 02 2013 12pm -0230 ()", fmtStr);
doTest(testBase + '("Wed October 02 2013 12pm -0230 ()", ' + 
    '"' + fmtStr + '") -> (UTC) 9, 2, 2013, 14, 30, 0',
    dP, testDateValue_u(dP, 2013, 9, 2, 14, 30, 0));

fmtStr = "%a %B %d %Y %I%P %z %Z";
dP = testObj.parse("Wed October 02 2013 12pm -0230", fmtStr);
doTest(testBase + '("Wed October 02 2013 12pm -0230", ' + 
    '"' + fmtStr + '") -> (UTC) 9, 2, 2013, 14, 30, 0',
    dP, testDateValue_u(dP, 2013, 9, 2, 14, 30, 0));

testObj = new _DTF("fr");
fmtStr = "%d###%t%b";
testInput = "29eme\tféV";
dP = testObj.parse(testInput, fmtStr);
doTest(testBase + '("29eme\\tféV","' + fmtStr + '") -> -, 1, 29',
    dP, testDateValue(dP, null, 1, 29));

testObj = new _DTF();
fmtStr = "%d##%n%b";
testInput = "29th\nfeb";
dP = testObj.parse(testInput, fmtStr);
doTest(testBase + '("29th\\nFeb","' + fmtStr + '") -> -, 1, 29',
    dP, testDateValue(dP, null, 1, 29));

fmtStr = "%d##%%%%%b";
testInput = "29th%%feb";
dP = testObj.parse(testInput, fmtStr);
doTest(testBase + '("' + testInput + '","' + fmtStr + '") -> -, 1, 29',
    dP, testDateValue(dP, null, 1, 29));

dt = testObj.parse("C20Y02M08D26", "C%CY%yM%mD%d");
doTest(testBase + '("C20Y02M08D26", "C%CY%yM%mD%d") -> 2002, 7, 26',
    dt, testDateValue(dt, 2002, 7, 26));

dt = testObj.parse("29", "%y");
doTest(testBase + '("29", "%y") -> 2029',
    dt, testDateValue(dt, 2029));

dt = testObj.parse("30", "%y");
doTest(testBase + '("30", "%y") -> 1930',
    dt, testDateValue(dt, 1930));

dt = testObj.parse("1380460194", "%s");
doTest(testBase + '("1380460194", "%s") -> (UTC) 2013, 8, 29, 13, 9, 54',
    dt, testDateValue_u(dt, 2013, 8, 29, 13, 9, 54));

testObj = new _DTF("zh");
dt = testObj.parse("下午01:09:54", "%r");
doTest(testBase + '("下午01:09:54", "%r") -> -, -, -, 13, 9, 54',
    dt, testDateValue(dt, null, null, null, 13, 9, 54));

testObj = new _DTF("cy");
dt = testObj.parse("Ion 8 2013 12:00:00 y.b.", "%b %e %Y %r");
doTest(testBase + '("Ion 8 2013 12:00:00 y.b.", "%b %e %Y %r") -> -, -, -, 0, 0, 0',
    dt, testDateValue(dt, null, null, null, 0, 0, 0));

dt = testObj.parse("Ion 8 2013 12:00:00 y.p.", "%b %e %Y %r");
doTest(testBase + '("Ion 8 2013 12:00:00 y.p.", "%b %e %Y %r") -> -, -, -, 12, 0, 0',
    dt, testDateValue(dt, null, null, null, 12, 0, 0));

dt = testObj.parse("Ion 8 2013 6:00:00 y.h.", "%b %e %Y %r");
doTest(testBase + '("Ion 8 2013 6:00:00 y.h.", "%b %e %Y %r") -> -, -, -, 18, 0, 0',
    dt, testDateValue(dt, null, null, null, 18, 0, 0));

dt = testObj.parse("-12(81)", "%C(%y)");
doTest(testBase + '("-12(81)", "%C(%y)") -> -1281',
    dt, testDateValue(dt, -1281));

dt = testObj.parse("-012(0081)", "%C(%y)");
doTest(testBase + '("-012(0081)", "%C(%y)") -> -1281',
    dt, testDateValue(dt, -1281));

dt = testObj.parse("025ms", "%/ms");
doTest(testBase + '("025ms", "%/ms") -> 25',
    dt, dt.getMilliseconds() === 25);

dt = testObj.parse("-00 01 01 02", "%C %y %m %d");
doTest(testBase + '("-00 01 01 02", "%C %y %m %d") -> -1, 0, 2',
    dt, testDateValue(dt, -1, 0, 2));

dt = testObj.parse("2013-365", "%Y-%j");
doTest(testBase + '("2013-365", "%Y-%j") -> 11 31',
    dt, testDateValue(dt, null, 11, 31));

dt = testObj.parse("366", "%j");
doTest(testBase + '("366", "%j") -> 11 31',
    dt, testDateValue(dt, null, 11, 31));

// Week number test
dt = testObj.parse("2012 53 1", "%Y %W %w");
doTest(testBase + '("2012 53 1", "%Y %W %w") -> 2012, 11, 31',
    dt, testDateValue(dt, 2012, 11, 31));

dt = testObj.parse("2013 0 2", "%Y %W %w");
doTest(testBase + '("2013 0 2", "%Y %W %w") -> 2013, 0, 1',
    dt, testDateValue(dt, 2013, 0, 1));

dt = testObj.parse("2013 0 0", "%Y %W %w");
doTest(testBase + '("2013 0 0", "%Y %W %w") -> 2013, 0, 6',
    dt, testDateValue(dt, 2013, 0, 6));

dt = testObj.parse("2013 0 7", "%Y %W %u");
doTest(testBase + '("2013 0 7", "%Y %W %u") -> 2013, 0, 6',
    dt, testDateValue(dt, 2013, 0, 6));

dt = testObj.parse("2013 1 1", "%Y %W %w");
doTest(testBase + '("2013 1 1", "%Y %W %w") -> 2013, 0, 7',
    dt, testDateValue(dt, 2013, 0, 7));

dt = testObj.parse("2013 40 1", "%Y %U %w");
doTest(testBase + '("2013 40 1", "%Y %U %w") -> 2013, 9, 7',
    dt, testDateValue(dt, 2013, 9, 7));

dt = testObj.parse("2012 53 0", "%Y %U %w");
doTest(testBase + '("2012 53 0", "%Y %U %w") -> 2012, 11, 30',
    dt, testDateValue(dt, 2012, 11, 30));

dt = testObj.parse("2012 52 6", "%Y %U %w");
doTest(testBase + '("2012 52 6", "%Y %U %w") -> 2012, 11, 29',
    dt, testDateValue(dt, 2012, 11, 29));

dt = testObj.parse("2013 0 6", "%Y %U %w");
doTest(testBase + '("2013 0 6", "%Y %U %w") -> 2013, 0, 5',
    dt, testDateValue(dt, 2013, 0, 5));

dt = testObj.parse("2013 1 7", "%Y %U %u");
doTest(testBase + '("2013 1 7", "%Y %U %u") -> 2013, 0, 6',
    dt, testDateValue(dt, 2013, 0, 6));

dt = testObj.parse("2013 1 0", "%Y %U %w");
doTest(testBase + '("2013 1 0", "%Y %U %w") -> 2013, 0, 6',
    dt, testDateValue(dt, 2013, 0, 6));

dt = testObj.parse("2009-53-4", "%G-%V-%u");
doTest(testBase + '("2009-53-4", "%G-%V-%u") -> 2009, 11, 31',
    dt, testDateValue(dt, 2009, 11, 31));

dt = testObj.parse("2009-53-5", "%G-%V-%u");
doTest(testBase + '("2009-53-5", "%G-%V-%u") -> 2010, 0, 1',
    dt, testDateValue(dt, 2010, 0, 1));

dt = testObj.parse("2009-53-7", "%G-%V-%u");
doTest(testBase + '("2009-53-7", "%G-%V-%u") -> 2010, 0, 3',
    dt, testDateValue(dt, 2010, 0, 3));

// Alternative nominative and genitive forms
testObj = new _DTF("el");
fmtStr = "%e %B %Y";
testInput = "1 Δεκεμβρίου 2013";
dt = testObj.parse(testInput, fmtStr);
doTest(testBase + '("' + testInput + '", "' + fmtStr + '") -> 2013, 11, 1',
    dt, testDateValue(dt, 2013, 11, 1));

fmtStr = "%B %Y";
testInput = "Δεκέμβριος 2013";
dt = testObj.parse(testInput, fmtStr);
doTest(testBase + '("' + testInput + '", "' + fmtStr + '") -> 2013, 11, 1',
    dt, testDateValue(dt, 2013, 11, 1));

// Alt calendars
testObj = new _DTF("en-u-ca-buddhist");
testInput = "0 BE";
fmtStr = "%Y %!";
dt = testObj.parse(testInput, fmtStr);
doTest(testBase + '("' + testInput + '", "' + fmtStr + '") -> -543',
    dt, testDateValue(dt, -543));

msg += eol;

formatHdr('UsefulJS.Event');

var _E = UsefulJS.Event;

msg += '<div class="outer"><div class="inner" id="clickme">Click me</div></div>';
msg += '<div class="outer"><div class="inner" id="dblclickme">Dblclick me</div></div>';

formatHdr('Event tests');

var evtReceived = null, evtRoot = null, evtProp = null;
var _custHandler = function(e, t, s, r) {
    evtReceived = t;
    evtRoot = r;
    evtProp = e.detail.message;
};
testBase = "UsefulJS.Event";
testVal = _E.register(null, "dummy", _custHandler);

doTest(testBase + '.register(null, "dummy", ' + _custHandler + ') === true',
    testVal, testVal === true);

testVal = _E.register(null, "dummy", _custHandler);
doTest(testBase + '.register(null, "dummy", ' + _custHandler + ') === false',
    testVal, testVal === false);

_E.fire("dummy", null, { message : "Duck!" } );
doTest(testBase + '.fire("dummy", null, { message : "Duck!" } ) hits the event handler',
    [evtReceived, evtRoot, evtProp], (evtReceived === "dummy" &&
        evtRoot === window && evtProp === "Duck!"));

testVal = _E.deregister(null, "dummy", _custHandler);
doTest(testBase + '.deregister(null, "dummy", ' + _custHandler + ') === true',
    testVal, testVal === true);

testVal = _E.deregister(null, "dummy", _custHandler);
doTest(testBase + '.deregister(null, "dummy", ' + _custHandler + ') === false',
    testVal, testVal === false);
    
msg += eol;


formatHdr('UsefulJS.DnD');

msg += '<div id="dragContainer"><div id="dragSink"></div></div>';

msg += "Drag the balls into the box" + eol;

msg += eol;

formatHdr('UsefulJS.Skin');
msg += '<div id="stylable"></div>';
msg += "Click the element to reskin it" + eol;
msg += eol;

formatHdr('UsefulJS.Currency');
var _cu = _u.Currency;
testInput = 1000;
testVal = _cu.load("EUR", { USD : 1.3, GBP : 0.8 }).cnv(testInput).to("USD");
expected = 1300;
doTest(testInput + " euros converts to " + expected + " dollars",
    testVal, testVal === expected);
    
testVal = _cu.to("GBP");
expected = 800;
doTest(testInput + " euros converts to " + expected + " pounds",
    testVal, testVal === expected);

testVal = Math.round(_cu.from("USD").to("GBP"));
expected = 615;
doTest(testInput + " dollars converts to around " + expected + " pounds",
    testVal, testVal === expected);
    
testVal = Math.round(_cu.from("GBP").to("USD"));
expected = 1625;
doTest(testInput + " pounds converts to " + expected + " dollars",
    testVal, testVal === expected);
    
msg += eol;

_u.Locale.current = cL;

dt = new Date();

var dEqual = function(d1, d2) {
    return (d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate());
};

var tEqual = function(d1, d2) {
    return (d1.getHours() === d2.getHours() &&
        d1.getMinutes() === d2.getMinutes());
};

var dtEqual = function(d1, d2) {
    return (d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate() &&
        d1.getHours() === d2.getHours() &&
        d1.getMinutes() === d2.getMinutes());
};

var dmEqual = function(d1, d2) {
    return (d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate());
};

var ymEqual = function(d1, d2) {
    return (d1.getYear() === d2.getYear() &&
        d1.getMonth() === d2.getMonth());
};

var nEqual = function(n1, n2) {
    // Numbers get rounded
    if (n2 >= Math.floor(n1) && n2 <= Math.ceil(n1)) {
        return true;
    }
    return false;
};

var drawCal = function(fmtObj, loc) {
    var d = new Date(), cal = fmtObj.cal(), i, j,
        cTbl = '<table border="0" callpadding="0" cellspacing="0" class="cal">',
        cHeader = fmtObj.format(d);
    cTbl += '<tr><th colspan="7" class="chead">' + cHeader + '</th></tr>';
    cTbl += '<tr>';
    for (i = 0; i < 7; i++) {
        cTbl += '<th>' + cal[0][i] + '</th>';
    }
    cTbl += '</tr>';
    for (i = 1; i < cal.length; i++) {
        cTbl += '<tr>';
        for (j = 0; j < cal[i].length; j++) {
            cTbl += '<td><span>' + cal[i][j] + '</span></td>';
        }
        cTbl += '</tr>';
    }
    cTbl += '</table>';
    msg += cTbl + eol;
};

var interestingLocales = {
    "en-GB" : 1, "fr-CA" : 1, "es-CL" : 1, "nl-BE" : 1, "fr-CH" : 1,
    "sr-Latn" : 1, "sv-FI" : 1, "ar-DZ" : 1, "zh-Hant-TW" : 1,
    "bn-BD" : 1, "en-ZA" : 1, "en-IN" : 1
};

var exerciseLocale = function(loc, idx, a) {
    var dstr, parsedDate, passmark, lObj = _u.Locale.options(loc), fmtStr, nStr, i, 
        lName = loc;
    if (lObj.n) {
        lName += " - " + lObj.n;
    }
    formatHdr(lName);

    var testNumber = function(n, opts) {
        var fmtObj = new _NF(loc, opts), parseObj = new _NP(loc, opts),
            nstr = fmtObj.format(n, opts, loc);
        try {
            var m = parseObj.parse(nstr, loc);
            if (isNaN(m)) {
                throw new Error("NaN");
            }
            passmark = nEqual(n, m) ? pM_y : pM_n;
            msg += '<tr><td>' + passmark + (opts.style || "decimal") + ':' +
                '</td><td>' + nstr + '</td></tr>';
        }
        catch(e) {
            msg += '<tr><td colspan="2">' + pM_n + "Unparseable number string : " + 
                nstr + '</td></tr>';
            var a = [];
            for (var i = 0; i < nstr.length; i++) {
                a.push(nstr.charCodeAt(i).toString(16));
            }
            console.log(a);
        }
    };

    var testPattern = function(fmtObj, fmtStr, t, dIn) {
        dstr = fmtObj.format(dIn, fmtStr);
        var fMap = {
            date : dEqual,
            time : tEqual,
            datetime : dtEqual,
            daymonth : dmEqual,
            monthyear : ymEqual
        };
        try {
            parsedDate = fmtObj.parse(dstr, fmtStr);
            passmark = fMap[t](parsedDate, dIn) ? pM_y : pM_n;
            if (pM_n === passmark) {
                console.log([dstr, ' => ', parsedDate.toString()]);
            }
            msg += '<tr><td>' + passmark + fmtStr + ':' +
                '</td><td>' + dstr + '</td></tr>';
        }
        catch(e) {
            console.log(e);
            msg += '<tr><td colspan="2">' + pM_n + "Unparseable pattern : " + 
                fmtStr + "; " + dstr + '</td></tr>';
        }

    };

    msg += '<table border="0" cellpadding="3" cellspacing="1">';

    if (-1 === loc.indexOf("-") || interestingLocales[loc]) {
        testNumber(114890.534, {});
        testNumber(-114890.534, {});
        testNumber(0.856, { style : "percent", minimumSignificantDigits : 3 });
        testNumber(-0.856, { style : "percent", minimumSignificantDigits : 3 });
        //testNumber(1.67843e19, { style : "scientific", maximumSignificantDigits : 6 });
        //testNumber(-1.67843e-19, { style : "scientific", maximumSignificantDigits : 6 });
    }
    testNumber(10938219.222, { style : "currency", currency : _l[loc].cc });
    testNumber(-10938219.222, { style : "currency", currency : _l[loc].cc });

    if (-1 === loc.indexOf("-") || interestingLocales[loc]) {
        var fmts = {"%c" : "datetime"}
        var dtFmts = [
            { weekday : "long", year : "numeric", month : "long", day : "2-digit",
                hour : "2-digit", minute : "2-digit", second : "2-digit",
                hour12 : false },
            { weekday : "long", year : "numeric", month : "long", day : "numeric",
                hour : "numeric", minute : "2-digit", second : "2-digit",
                hour12 : true }
        ], dOpts, resolved = {}, fmtStr;
        dtFmts.forEach(function(opts) {
            resolved = {};
            dOpts = _u.Locale.dateOptions(loc, opts);
            fmtStr = _D.getFormatString(dOpts, resolved);
            fmts[fmtStr] = "datetime";
        });
        var dFmts = [
            { weekday : "short", year : "numeric", month : "short", day : "2-digit" },
            { year : "numeric", month : "long", day : "numeric" },
            { year : "2-digit", month : "2-digit", day : "2-digit" },
            {}
        ];
        dFmts.forEach(function(opts) {
            resolved = {};
            dOpts = _u.Locale.dateOptions(loc, opts);
            fmtStr = _D.getFormatString(dOpts, resolved);
            fmts[fmtStr] = "date";
        });
        var tFmts = [
            { hour : "2-digit", minute : "2-digit", second : "2-digit",
                hour12 : false, timeZoneName : "long" },
            { hour : "numeric", minute : "numeric", hour12 : true }
        ];
        tFmts.forEach(function(opts) {
            resolved = {};
            dOpts = _u.Locale.dateOptions(loc, opts);
            fmtStr = _D.getFormatString(dOpts, resolved);
            fmts[fmtStr] = "time";
        });
        var fmtObj = new _DTF(loc);
        for (fmtStr in fmts) {
            testPattern(fmtObj, fmtStr, fmts[fmtStr], dt);
        }

        // Eras
        var dEra = new Date(0, 0, 0, 0, 0, 0, 0),
            eraOpts = { year : "numeric", month : "long", day : "numeric", era : "short" };
        dEra.setFullYear(0);
        var eraLoc = loc;
        if (loc === "th") {
            fmtObj = new _DTF("th", eraOpts);
            testPattern(fmtObj, fmtObj.opts.fmt, "date", dt);
            eraLoc += "-u-ca-gregory";
        }
        else if (loc === "fa") {
            fmtObj = new _DTF("fa", eraOpts);
            testPattern(fmtObj, fmtObj.opts.fmt, "date", dt);
            eraLoc += "-u-ca-gregory";
        }
        else if (loc === "zh-Hant-TW") {
            fmtObj = new _DTF("zh-TW-u-ca-roc", eraOpts);
            testPattern(fmtObj, fmtObj.opts.fmt, "date", dt);
        }
        else if (loc === "hi") {
            fmtObj = new _DTF("hi-u-ca-indian", eraOpts);
            testPattern(fmtObj, fmtObj.opts.fmt, "date", dt);
        }
        else if (loc === "en-IN") {
            fmtObj = new _DTF("en-IN-u-ca-indian", eraOpts);
            testPattern(fmtObj, fmtObj.opts.fmt, "date", dt);
        }
        else if (loc === "ja") {
            fmtObj = new _DTF("ja-u-ca-japanese", eraOpts);
            testPattern(fmtObj, fmtObj.opts.fmt, "date", 
                new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()));
        }
        fmtObj = new _DTF(eraLoc, eraOpts);
        fmtStr = fmtObj.opts.fmt;
        // Positive date
        dEra.setTime(dEra.getTime() + 86400000);
        testPattern(fmtObj, fmtStr, "date", dEra);
        // Negative date
        dEra.setTime(dEra.getTime() - 86400000);
        testPattern(fmtObj, fmtStr, "date", dEra);
    }
    msg += '</table>' + eol;

    if (loc.indexOf('-') === -1) {
        fmtObj = new _DTF(loc, { year : "numeric", month : "long" });
        msg += eol;
        drawCal(fmtObj, loc);
    }

    msg += eol;
}, allLocales = _u.Locale.getSupported();

var str = "Locale exercises", langC = 0, locC = 0;
allLocales.sort();
allLocales.forEach(function(loc) {
    ++locC; 
    if (loc.indexOf('-') === -1) {
        ++langC;
    }
});
str += " (" + langC + " languages, " + locC + " locales)";
formatHdr(str);

allLocales.forEach(exerciseLocale);

msg += eol;

}
catch(e) { msg += e.message + eol; }
p.innerHTML = msg;

var cArea = document.getElementById("clickme"), dcArea = document.getElementById("dblclickme");

var ClickHandler = function() {
    this.handler = function(evt, evtType, evtSrc, evtRoot) {
        var oText = "Click me", nText = "Clicked";
        if ("dblclick" === evtType) {
            // Get rid of text selection
            if (window.getSelection) {
                window.getSelection().removeAllRanges();
            }
            else if (document.selection) {
                document.selection.empty();
            }
            oText = "Dblclick me";
            nText = "Dblclicked";
        }
        evtRoot.innerHTML = nText;
        setTimeout(function() {
            evtRoot.innerHTML = oText;
        }, 500);
    };
}, clickHandler = new ClickHandler();
if (cArea) {
    _E.register(cArea, "click", clickHandler.handler, clickHandler);
}
if (dcArea) {
    _E.register(dcArea, "dblclick", clickHandler.handler, clickHandler);
}

// Set up the drag-and-drop demonstration
(function() {
    var ctr = document.getElementById("dragContainer"), 
        sink = document.getElementById("dragSink"), 
        sinkC = UsefulJS.DnD.elementOffset(sink, ctr),
        sinkBX = sinkC[0] + sink.clientWidth,
        sinkBY = sinkC[1] + sink.clientHeight,
        i;
        
    // Record of starting positions
    var sPos = {};
    
    var dragStart = function(evt, evtSrc) {
        if (evtSrc.className !== "ball") {
            return null;
        }
        evtSrc.style.zIndex = 1;
        return evtSrc;
    };

    var dragEnd = function(evt, x, y, dragEl) {
        var p = dragEl.parentNode, eId = dragEl.id;
        dragEl.style.zIndex = 0;
        var putBack = function() {
            var xy = sPos[eId];
            dragEl.style.left = xy[0] + "px";
            dragEl.style.top = xy[1] + "px";
            p.appendChild(dragEl);
        };
        if (x > sinkC[0] && x < sinkBX && y > sinkC[1] && y < sinkBY) {
            // In the sink
            p.removeChild(dragEl);
            sink.classList.remove("droppable");
            setTimeout(putBack, 1000);
        }
    };
    
    var dragUpdate = function(evt, x, y, dragEl, complete) {
        if (complete) {
            dragEnd(evt, x, y, dragEl);
            return;
        }
        var cl = sink.classList;
        if (x > sinkC[0] && x < sinkBX && y > sinkC[1] && y < sinkBY) {
            // Over the sink
            cl.add("droppable");
        }
        else if (cl.contains("droppable")) {
            cl.remove("droppable");
        }
    }
        
    // Random ball positions
    for (i = 1; i <= 8; i++) {
        var posX, posY, j = 0;
        do {
            posX = Math.floor(Math.random() * (ctr.clientWidth - 28));
            posY = Math.floor(Math.random() * (ctr.clientHeight - 28));
        }
        while (posX < (sinkBX + 28) && posY < (sinkBY + 28) && ++j < 20);
        var b = document.createElement("div"), eId = UsefulJS.uuid();
        b.className = "ball";
        b.style.left = posX + "px";
        b.style.top = posY + "px";
        b.id = eId;
        sPos[eId] = [posX, posY];
        b.appendChild(document.createTextNode(i));
        ctr.appendChild(b);
    }
    UsefulJS.DnD.register(ctr, ctr, dragStart, dragUpdate);

})();

(function() {
    var sheets = UsefulJS.Skin.load(), 
        stE = document.getElementById("stylable"),
        active = sheets[0];
    stE.innerHTML = active;   
    
    UsefulJS.Event.register(stE, "click", function() {
        if (active === sheets[0]) {
            active = sheets[1];
        }
        else {
            active = sheets[0];
        }
        stE.innerHTML = active;
        UsefulJS.Skin.choose(active);
    });

})();

}
// END_JAVASCRIPT
</script>
<script src="http://code.jquery.com/jquery.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
</body>
</html>
